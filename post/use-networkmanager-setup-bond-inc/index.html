<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>使用NetworkManger初始化Bond - Even - A super concise theme for Hugo</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Yafa Xena"><meta name=description content="前言 之前手动配置Bond容易出错，查看了一下Redhat的官方文档，发现是可以通过NetworkManager去配置Bond的，这篇文章是记录如何使用NetworkManager去配置Bond的。"><meta name=keywords content="Linux,Emacs,Python,Golang,Devops,Zabbix,Kubernetes,Gentoo"><meta name=generator content="Hugo 0.79.1 with theme even"><link rel=canonical href=https://www.yafa.moe/post/use-networkmanager-setup-bond-inc/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="使用NetworkManger初始化Bond"><meta property="og:description" content="前言
之前手动配置Bond容易出错，查看了一下Redhat的官方文档，发现是可以通过NetworkManager去配置Bond的，这篇文章是记录如何使用NetworkManager去配置Bond的。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.yafa.moe/post/use-networkmanager-setup-bond-inc/"><meta property="article:published_time" content="2021-03-06T15:25:54+08:00"><meta property="article:modified_time" content="2021-03-06T15:25:54+08:00"><meta itemprop=name content="使用NetworkManger初始化Bond"><meta itemprop=description content="前言
之前手动配置Bond容易出错，查看了一下Redhat的官方文档，发现是可以通过NetworkManager去配置Bond的，这篇文章是记录如何使用NetworkManager去配置Bond的。"><meta itemprop=datePublished content="2021-03-06T15:25:54+08:00"><meta itemprop=dateModified content="2021-03-06T15:25:54+08:00"><meta itemprop=wordCount content="982"><meta itemprop=keywords content="networkmanager,linux,bond,"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用NetworkManger初始化Bond"><meta name=twitter:description content="前言
之前手动配置Bond容易出错，查看了一下Redhat的官方文档，发现是可以通过NetworkManager去配置Bond的，这篇文章是记录如何使用NetworkManager去配置Bond的。"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Yafa-Xena</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/todo><li class=mobile-menu-item>Todo</li></a><a href=/about><li class=mobile-menu-item>About</li></a><a href=/product><li class=mobile-menu-item>Product</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Yafa-Xena</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/todo>Todo</a></li><li class=menu-item><a class=menu-item-link href=/about>About</a></li><li class=menu-item><a class=menu-item-link href=/product>Product</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>使用NetworkManger初始化Bond</h1><div class=post-meta><span class=post-time>2021-03-06</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#环境初始化>环境初始化</a></li><li><a href=#bond模式说明>bond模式说明</a></li><li><a href=#配置bond>配置bond</a></li><li><a href=#验证>验证</a></li><li><a href=#后记>后记</a></li><li><a href=#参考链接>参考链接</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=前言>前言</h2><p>之前手动配置Bond容易出错，查看了一下Redhat的官方文档，发现是可以通过NetworkManager去配置Bond的，这篇文章是记录如何使用NetworkManager去配置Bond的。</p><h2 id=环境初始化>环境初始化</h2><p>这次的测试环境如下</p><table><thead><tr><th>hostname</th><th>test network</th></tr></thead><tbody><tr><td>bond-node1</td><td>172.11.0.23/22</td></tr><tr><td>bond-node2</td><td>172.11.0.24/22</td></tr></tbody></table><p>初始化<code>bond-node1</code></p><p>首先查看当前的网络</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>sudo virsh domiflist bond-node1
 Interface   Type      Source    Model    MAC
-------------------------------------------------------------
 vnet3       network   default   virtio   52:54:00:64:b9:13
</code></pre></td></tr></table></div></div><p>删除原来的default网络</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>sudo virsh detach-interface --domain bond-node1 --type network --mac 52:54:00:64:b9:13 --config --live
</code></pre></td></tr></table></div></div><p>添加2张连接<code>test</code>网络的网卡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell> sudo virsh attach-interface --domain bond-node1 --type network <span class=se>\
</span><span class=se></span>--source <span class=nb>test</span> --model virtio --config --live
 sudo virsh attach-interface --domain bond-node1 --type network <span class=se>\
</span><span class=se></span>--source <span class=nb>test</span> --model virtio --config --live
</code></pre></td></tr></table></div></div><p>验证：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>sudo virsh domiflist bond-node1
 Interface   Type      Source   Model    MAC
------------------------------------------------------------
 vnet5       network   <span class=nb>test</span>     virtio   52:54:00:6c:bd:a9
 vnet6       network   <span class=nb>test</span>     virtio   52:54:00:d7:22:97
</code></pre></td></tr></table></div></div><p>另外的一个bond-node2也是如法炮制。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>sudo virsh detach-interface --domain bond-node2 --type network --mac 52:54:00:c3:65:bf --config --live
 sudo virsh attach-interface --domain bond-node2 --type network <span class=se>\
</span><span class=se></span>--source <span class=nb>test</span> --model virtio --config --live
 sudo virsh attach-interface --domain bond-node2 --type network <span class=se>\
</span><span class=se></span>--source <span class=nb>test</span> --model virtio --config --live
</code></pre></td></tr></table></div></div><h2 id=bond模式说明>bond模式说明</h2><table><thead><tr><th style=text-align:left>Mode</th><th style=text-align:left>Policy</th><th style=text-align:left>How it works</th><th style=text-align:left>Fault Tolerance</th><th style=text-align:left>Load balancing</th></tr></thead><tbody><tr><td style=text-align:left>0</td><td style=text-align:left>Round Robin</td><td style=text-align:left>packets are sequentially transmitted/received through each interfaces one by one.</td><td style=text-align:left>No</td><td style=text-align:left>Yes</td></tr><tr><td style=text-align:left>1</td><td style=text-align:left>Active Backup</td><td style=text-align:left>one NIC active while another NIC is asleep. If the active NIC goes down, another NIC becomes active. only supported in x86 environments.</td><td style=text-align:left>Yes</td><td style=text-align:left>No</td></tr><tr><td style=text-align:left>2</td><td style=text-align:left>XOR [exclusive OR]</td><td style=text-align:left>In this mode the, the MAC address of the slave NIC is matched up against the incoming request’s MAC and once this connection is established same NIC is used to transmit/receive for the destination MAC.</td><td style=text-align:left>Yes</td><td style=text-align:left>Yes</td></tr><tr><td style=text-align:left>3</td><td style=text-align:left>Broadcast</td><td style=text-align:left>All transmissions are sent on all slaves</td><td style=text-align:left>Yes</td><td style=text-align:left>No</td></tr><tr><td style=text-align:left>4</td><td style=text-align:left>Dynamic Link Aggregation</td><td style=text-align:left>aggregated NICs act as one NIC which results in a higher throughput, but also provides failover in the case that a NIC fails. Dynamic Link Aggregation requires a switch that supports IEEE 802.3ad.</td><td style=text-align:left>Yes</td><td style=text-align:left>Yes</td></tr><tr><td style=text-align:left>5</td><td style=text-align:left>Transmit Load Balancing (TLB)</td><td style=text-align:left>The outgoing traffic is distributed depending on the current load on each slave interface. Incoming traffic is received by the current slave. If the receiving slave fails, another slave takes over the MAC address of the failed slave.</td><td style=text-align:left>Yes</td><td style=text-align:left>Yes</td></tr><tr><td style=text-align:left>6</td><td style=text-align:left>Adaptive Load Balancing (ALB)</td><td style=text-align:left>Unlike Dynamic Link Aggregation, Adaptive Load Balancing does not require any particular switch configuration. Adaptive Load Balancing is only supported in x86 environments. The receiving packets are load balanced through ARP negotiation.</td><td style=text-align:left>Yes</td><td style=text-align:left>Yes</td></tr></tbody></table><h2 id=配置bond>配置bond</h2><p>bond-node1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>sudo virsh console bond-node1
</code></pre></td></tr></table></div></div><p>设置主机名：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>hostnamectl set-hostname bond-node1
</code></pre></td></tr></table></div></div><p>配置bond0模式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>nmcli con add <span class=nb>type</span> bond ifname bond0 bond.options <span class=s2>&#34;mode=balance-rr,miimon=100&#34;</span>
</code></pre></td></tr></table></div></div><p>配置bond4模式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>nmcli con add <span class=nb>type</span> bond ifname bond0 bond.options <span class=s2>&#34;mode=802.3ad,miimon=100&#34;</span>
</code></pre></td></tr></table></div></div><p>同时需要配置内核自动加载模块</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=c1># /etc/modules-load.d/bonding.conf</span>
8021q
</code></pre></td></tr></table></div></div><p>添加slave网卡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>nmcli con add <span class=nb>type</span> ethernet ifname eth0 master bond0
nmcli con add <span class=nb>type</span> ethernet ifname eth1 master bond0
</code></pre></td></tr></table></div></div><p>启动网卡</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>nmcli con up bond-slave-eth0
nmcli con up bond-slave-eth1
</code></pre></td></tr></table></div></div><p>配置ip</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>nmcli connection modify bond-bond0 ipv4.method manual ipv4.addresses <span class=s2>&#34;172.11.0.23/22&#34;</span> ipv4.dns 114.114.114.114 ipv4.gateway 172.11.0.1 connection.autoconnect yes
nmcli con up bond-bond0
</code></pre></td></tr></table></div></div><p>bond-node2</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>nmcli connection modify bond-bond0 ipv4.method manual ipv4.addresses <span class=s2>&#34;172.11.0.24/22&#34;</span> ipv4.dns 114.114.114.114 ipv4.gateway 172.11.0.1 connection.autoconnect yes
nmcli con up bond-bond0
</code></pre></td></tr></table></div></div><h2 id=验证>验证</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>cat /proc/net/bonding/bond0
</code></pre></td></tr></table></div></div><p>这里可以做一个性能测试来看是否工作正常
安装<code>iperf</code>工具两个节点都需要：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>yum install epel-release -y
yum install -y iperf 
</code></pre></td></tr></table></div></div><p>这里是将bond-node1作为服务端，bond-node2作为客户端进行测试。</p><p>首先开放防火墙，和启动服务端（bond-node1）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>firewall-cmd --zone<span class=o>=</span>public  --add-port<span class=o>=</span>5001/tcp
iperf -s -i <span class=m>1</span> -w 448k
</code></pre></td></tr></table></div></div><p>bond-node2：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>iperf -c 172.11.0.23 -i <span class=m>1</span> -w 448k -t <span class=m>600</span>
</code></pre></td></tr></table></div></div><h2 id=后记>后记</h2><p>测试了以下boding感觉还是需要强大的硬件，没有强大的硬件没办法很好玩bonding（一个支持LACP的交换机）。</p><h2 id=参考链接>参考链接</h2><ul><li><a href=https://www.thegeekdiary.com/centos-rhel-7-how-to-configure-network-bonding-or-nic-teaming/>CentOS / RHEL 7 : How to configure Network Bonding or NIC teaming</a></li><li><a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux_openstack_platform/7/html/director_installation_and_usage/app-bonding_options>Redhat APPENDIX H. BONDING OPTIONS</a></li><li><a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/sec-network_bonding_using_the_networkmanager_command_line_tool_nmcli>Redhat Networking Guide: 7.3. NETWORK BONDING USING THE NETWORKMANAGER COMMAND LINE TOOL, NMCLI</a></li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>Yafa Xena</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2021-03-06</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/networkmanager/>networkmanager</a>
<a href=/tags/linux/>linux</a>
<a href=/tags/bond/>bond</a></div><nav class=post-nav><a class=prev href=/post/rsyslog/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Rsyslog服务器配置和使用</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/automatic-deployment-blog/><span class="next-text nav-default">Automatic Deployment Blog</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=yafa-xena/yafa-xena/blog-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:i@yafa.moe class="iconfont icon-email" title=email></a><a href=https://twitter.com/XenaYafa class="iconfont icon-twitter" title=twitter></a><a href=https://github.com/yafa-xena/ class="iconfont icon-github" title=github></a><a href=https://www.yafa.moe/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2021<span class=heart><i class="iconfont icon-heart"></i></span><span>Yafa Xena</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script type=text/javascript>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],tags:'ams',}};</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script></body></html>