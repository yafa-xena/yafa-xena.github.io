<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>在Mac上安装Gentoo Linux - Yafa Xena's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Yafa Xena"><meta name=description content="前言 这不是一份简短的Gentoo Linux安装手册，我想在这篇文章中向你展示更多Gentoo Linux的魅力。
 为什么选择Gentoo？
 Gentoo 是一个基于源码的滚动发行版。 Gentoo的基础包和软件都是由源码来构建的并且有Portage的USE标记来开启或者是关闭软件的特性。Gentoo提供了一个类似于ports的系统（Portage）所以Gentoo更适合于系统的定制化。"><meta name=keywords content="Linux,Emacs,Python,Golang,Devops,Zabbix,Kubernetes,Gentoo"><meta name=generator content="Hugo 0.79.1 with theme even"><link rel=canonical href=https://www.yafa.moe/post/install-gentoo-on-mac/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="在Mac上安装Gentoo Linux"><meta property="og:description" content="前言
这不是一份简短的Gentoo Linux安装手册，我想在这篇文章中向你展示更多Gentoo Linux的魅力。

为什么选择Gentoo？

Gentoo 是一个基于源码的滚动发行版。 Gentoo的基础包和软件都是由源码来构建的并且有Portage的USE标记来开启或者是关闭软件的特性。Gentoo提供了一个类似于ports的系统（Portage）所以Gentoo更适合于系统的定制化。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.yafa.moe/post/install-gentoo-on-mac/"><meta property="article:published_time" content="2021-01-18T19:41:36-05:00"><meta property="article:modified_time" content="2021-01-18T19:41:36-05:00"><meta itemprop=name content="在Mac上安装Gentoo Linux"><meta itemprop=description content="前言
这不是一份简短的Gentoo Linux安装手册，我想在这篇文章中向你展示更多Gentoo Linux的魅力。

为什么选择Gentoo？

Gentoo 是一个基于源码的滚动发行版。 Gentoo的基础包和软件都是由源码来构建的并且有Portage的USE标记来开启或者是关闭软件的特性。Gentoo提供了一个类似于ports的系统（Portage）所以Gentoo更适合于系统的定制化。"><meta itemprop=datePublished content="2021-01-18T19:41:36-05:00"><meta itemprop=dateModified content="2021-01-18T19:41:36-05:00"><meta itemprop=wordCount content="21994"><meta itemprop=keywords content="Linux,Gentoo,"><meta name=twitter:card content="summary"><meta name=twitter:title content="在Mac上安装Gentoo Linux"><meta name=twitter:description content="前言
这不是一份简短的Gentoo Linux安装手册，我想在这篇文章中向你展示更多Gentoo Linux的魅力。

为什么选择Gentoo？

Gentoo 是一个基于源码的滚动发行版。 Gentoo的基础包和软件都是由源码来构建的并且有Portage的USE标记来开启或者是关闭软件的特性。Gentoo提供了一个类似于ports的系统（Portage）所以Gentoo更适合于系统的定制化。"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Yafa-Xena</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/todo><li class=mobile-menu-item>Todo</li></a><a href=/about><li class=mobile-menu-item>About</li></a><a href=/product><li class=mobile-menu-item>Product</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Yafa-Xena</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/todo>Todo</a></li><li class=menu-item><a class=menu-item-link href=/about>About</a></li><li class=menu-item><a class=menu-item-link href=/product>Product</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>在Mac上安装Gentoo Linux</h1><div class=post-meta><span class=post-time>2021-01-18</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class=post-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#缘起>缘起</a></li><li><a href=#环境准备>环境准备</a><ul><li><a href=#制作安装介质>制作安装介质</a></li><li><a href=#启动安装介质>启动安装介质</a></li><li><a href=#配置ssh>配置SSH</a></li><li><a href=#连接到livecd>连接到livecd</a></li></ul></li><li><a href=#安装gentoo>安装Gentoo</a><ul><li><a href=#分区>分区</a></li><li><a href=#初始化文件系统>初始化文件系统</a></li><li><a href=#挂载分区>挂载分区</a></li><li><a href=#安装gentoo安装文件>安装Gentoo安装文件</a></li><li><a href=#portage-文件说明>Portage 文件说明</a></li><li><a href=#atoms-packages-categories-versions-sets-and-slots>Atoms, Packages, Categories, Versions, Sets and SLOTs</a></li><li><a href=#配置portage>配置Portage</a></li><li><a href=#chroot>Chroot</a></li><li><a href=#安装和更新portage-tree>安装和更新Portage Tree</a></li><li><a href=#设置基本的配置文件>设置基本的配置文件</a></li><li><a href=#设置时区和语言环境>设置时区和语言环境</a></li><li><a href=#通知portage使用特定的cpu功能>通知Portage使用特定的CPU功能</a></li><li><a href=#gentoo-bootstrap-从stage1到stage2>Gentoo Bootstrap: 从Stage1到Stage2</a></li><li><a href=#gentoo-bootstrap-从stage2到stage3>Gentoo Bootstrap 从Stage2到Stage3</a></li><li><a href=#验证bootstrap>验证bootstrap</a></li><li><a href=#切换配置文件>切换配置文件</a></li><li><a href=#安装和配置内核>安装和配置内核</a></li><li><a href=#生成initramfs>生成initramfs</a></li><li><a href=#安装bootload>安装bootload</a></li><li><a href=#配置fstab>配置fstab</a></li><li><a href=#安装网络组件>安装网络组件</a></li><li><a href=#设置主机名>设置主机名</a></li><li><a href=#添加和设置管理员账户>添加和设置管理员账户</a></li><li><a href=#安装网络组件-1>安装网络组件</a></li><li><a href=#安装系统推荐组件>安装系统推荐组件</a></li></ul></li><li><a href=#备份和清理工作>备份和清理工作</a><ul><li><a href=#清理>清理</a></li><li><a href=#配置文件备份>配置文件备份</a></li></ul></li><li><a href=#重启>重启</a></li><li><a href=#故障排除>故障排除</a></li><li><a href=#安装和配置桌面>安装和配置桌面</a><ul><li><a href=#安装kde桌面及应用>安装KDE桌面及应用</a></li><li><a href=#配置kde启动>配置KDE启动</a></li></ul></li><li><a href=#最后的话>最后的话</a></li><li><a href=#参考文档>参考文档</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=前言>前言</h2><p>这不是一份简短的Gentoo Linux安装手册，我想在这篇文章中向你展示更多Gentoo Linux的魅力。</p><blockquote><p>为什么选择Gentoo？</p></blockquote><p>Gentoo 是一个基于源码的滚动发行版。 Gentoo的基础包和软件都是由源码来构建的并且有Portage的USE标记来开启或者是关闭软件的特性。Gentoo提供了一个类似于ports的系统（Portage）所以Gentoo更适合于系统的定制化。</p><p>如果你有使用其他的Linux经验也可能会问为什么不用Archlinux，也是滚动发行版包管理器也比portage快。</p><p>你是对的，Portage的包管理工具比Arch或者是其他发行版的包管理更加复杂和强大，但是这是由于设计哲学上的问题：</p><p>Gentoo的目标是努力创建近乎理想的工具，可以满足许多不同目标用户的工具。</p><p>Arch的哲学就是： Keep It Simple, Stupid. 在简单的安装了一台虚拟机之后也确实感觉到了这一点。</p><p>但是我还是更喜欢Gentoo的设计一点，有一种整个系统尽在掌握的感觉。</p><blockquote><p>less is more, but more is also less.</p></blockquote><h2 id=缘起>缘起</h2><p>我是一个非常贫苦刚刚步入社会的学生。</p><p>今年毕业之后因为疫情的影响好不容易进了一家公司，但是日常的开销不足以让我更换掉现在的机器（只有单个核心的年迈机器。）。</p><p>前些日子在和一位<del>帅气的学长</del> 温柔的学姐在茶会上聊起了工作的一些事情可能是听到了我的抱怨了吧哈哈哈，当时说要送我一台笔记本，当时还在想不会吧？这两天收到了发现是一台Macbook Pro 2015年的15寸版本，还有一个yubico。</p><p>配置大概是这样子的</p><table><thead><tr><th>型号</th><th>CPU</th><th>内存</th><th>硬盘</th></tr></thead><tbody><tr><td>Macbook Pro 2015 15inch</td><td>I7 4770HQ</td><td>16G</td><td>2TB</td></tr></tbody></table><p>在此之前一直都有想要试试看Gentoo的想法，但是奈何手上的笔记本只有可怜的单核2G内存，因为日常还需要使用的缘故结果自然也是不了了之。</p><p>这次就有机会尝试一下了，并且将其作为主力系统进行使用。</p><p>这次安装Gentoo打算使用这样的组合：</p><table><thead><tr><th>类别</th><th>包或包组</th><th>说明</th></tr></thead><tbody><tr><td>基础系统</td><td><code>@system</code></td><td>基础系统</td></tr><tr><td>X Windows</td><td>Xorg Server</td><td>使用Xorg作为X Windows的后端服务</td></tr><tr><td>桌面</td><td>kde</td><td>本次安装将会使用KDE桌面</td></tr><tr><td>输入法</td><td>fcitx-rime</td><td>使用fcitx作为输入法框架，使用rime输入法作为日常使用</td></tr><tr><td>浏览器</td><td>chromium + firefox</td><td>多来几个浏览器方便debug</td></tr><tr><td>邮箱客户端</td><td>thunderbird</td><td>雷鸟邮件客户端</td></tr><tr><td>密码管理器</td><td>keepassxc + pass</td><td>一个为gui的一个为命令行的密码管理器</td></tr><tr><td>截图软件</td><td>flameshot</td><td>很棒的截图软件</td></tr></tbody></table><h2 id=环境准备>环境准备</h2><p>先来说明一下安装Gentoo的环境准备。</p><p>我这里是准备了以下：</p><ol><li>Macbook Pro * 1 （安装机器）</li><li>Dell 老机器 * 1 （我将会在这个节点进行操作）</li><li>U盘 * 1 （安装介质）</li><li>USB千兆网卡 （因为发现在Gentoo下面无线有问题，信道支持有限，在Ubuntu Livecd下工作正常，正在尝试解决这个问题。）
拓扑图如下：</li></ol><p><img src=../../images/network_arch.png alt=Network_Arch></p><h3 id=制作安装介质>制作安装介质</h3><p>之前一直有听说Gentoo安装比较麻烦，看了一些关于Gentoo安装的文档，我认为难点在于内核的配置上，其他应该问题不大（😂）。</p><p>为了能够最大程度少去配置内核我这里选择了Ubuntu Desktop Livecd，将会以这个内核配置为基础进行自己的内核配置</p><blockquote><p>下载ISO文件</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>wget -c https://mirrors.aliyun.com/ubuntu-releases/20.10/ubuntu-20.10-desktop-amd64.iso
</code></pre></td></tr></table></div></div><blockquote><p>制作USB启动盘</p></blockquote><p>将U盘插入这台老的Dell机器然后使用<code>dd</code>刻录安装介质</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>sudo dd <span class=k>if</span><span class=o>=</span>ubuntu-20.10-desktop-amd64.iso <span class=nv>of</span><span class=o>=</span>/dev/sdb <span class=nv>bs</span><span class=o>=</span>20M <span class=nv>status</span><span class=o>=</span>progress
</code></pre></td></tr></table></div></div><p>耐心等待程序执行完成。</p><p>等到执行完成之后你就有了一个Ubuntu 20.10 Desktop的安装介质</p><h3 id=启动安装介质>启动安装介质</h3><p>将制作好的启动介质插到Macbook Pro上然后按住<code>Option</code>键再按开机，会出现一个EFI的选项，这个EFI选项就是我们的Ubuntu安装介质选择这个然后回车启动！</p><p>接下来会出现一个Grub菜单，选择 <code>safe graphical</code> 这个选项回车。</p><p><img src=../../images/grub.png alt="Grub Menu"></p><p>接下来会检测磁盘分区如果不喜欢可以选择 Ctrl+c 结束掉。
<img src=../../images/check_disk.png alt="Check Disk"></p><p>最后来到Ubuntu的欢迎界面，这里选择 Try Ubuntu
<img src=../../images/welcome_ubuntu.png alt="Welcome Come Ubuntu"></p><h3 id=配置ssh>配置SSH</h3><p>首先右键桌面打开终端：</p><p><img src=../../images/open_terminal.png alt="Open Terminal"></p><p>输入 <code>sudo -i</code> 提升为<code>root</code>用户</p><p><img src=../../images/sudo.png alt=sudo></p><blockquote><p>配置密码</p></blockquote><p>为了能够正常连接到这个livdcd环境还需要给这个livecd配置一个密码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>passwd ubuntu <span class=c1># 输入密码没有回显，不是你没有输入</span>
</code></pre></td></tr></table></div></div><p><img src=../../images/change_password.png alt="Change Password"></p><blockquote><p>配置<code>openssh-server</code></p></blockquote><p>除此之外还需要配置<code>openssh-server</code>来让我的另外一台电脑可以通过ssh进行链接</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>apt-get update <span class=o>&amp;&amp;</span> apt-get install openssh-server -y <span class=o>&amp;&amp;</span> systemctl start sshd <span class=o>&amp;&amp;</span> systemctl status sshd
</code></pre></td></tr></table></div></div><p><img src=../../images/setup_openssh_server.png alt="Setup Openssh Server">
如上图所示可以看到<code>openssh-server</code>已经运行了，接下来我们需要验证一下是否可以正常链接。</p><p>使用<code>ip</code>命令查看当前主机分配到的ip</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>ip addr show
</code></pre></td></tr></table></div></div><p><img src=../../images/show_ip.png alt="Show IP"></p><p>这里的<code>enp1s0</code>就是物理网卡<code>192.168.122.230</code>就是我们livecd获取到的地址我们可以通过这个ip来进行链接。</p><h3 id=连接到livecd>连接到livecd</h3><p>使用<code>ssh</code>命令来连接到livecd</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>ssh ubuntu@192.168.122.230
</code></pre></td></tr></table></div></div><p>ubuntu用户就是我们设置过密码的管理员账户</p><p>192.168.122.230就是livecd通过DHCP获取到的地址</p><p><img src=../../images/connect_to_livecd.png alt="Connect to livecd"></p><h2 id=安装gentoo>安装Gentoo</h2><p>在能够正常连接到livecd之后我们就可以开始安装Gentoo了</p><h3 id=分区>分区</h3><p>使用<code>fdisk</code> 查看当前分区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>fdisk -l
</code></pre></td></tr></table></div></div><p><img src=../../images/check_partition.png alt="Check Partition"></p><p>这里的<code>/dev/nvme0n1</code>就是Mac的硬盘，我的Gentoo系统也会安装到这里。</p><p>这次分区我打算使用LUKS做一个全盘加密，分区就比较简单：</p><table><thead><tr><th>文件系统</th><th>类型</th><th>挂载点</th><th>大小</th></tr></thead><tbody><tr><td>/dev/nvme0n1p1</td><td>fat32</td><td>/boot</td><td>64M</td></tr><tr><td>/dev/nvme0n1p2</td><td>luks</td><td>nil</td><td>all</td></tr><tr><td>/dev/mapper/root</td><td>ext4</td><td>/</td><td>all</td></tr></tbody></table><p>使用<code>fdisk</code>来进行分区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>fdisk /dev/nvme0n1
Welcome to fdisk <span class=o>(</span>util-linux 2.36<span class=o>)</span>.
Changes will remain in memory only, <span class=k>until</span> you decide to write them.
Be careful before using the write command.


Command <span class=o>(</span>m <span class=k>for</span> <span class=nb>help</span><span class=o>)</span>: n <span class=c1># 创建新的分区</span>
Partition number <span class=o>(</span>1-128, default 1<span class=o>)</span>:
First sector <span class=o>(</span>34-4000797326, default 2048<span class=o>)</span>:
Last sector, +/-sectors or +/-size<span class=o>{</span>K,M,G,T,P<span class=o>}</span> <span class=o>(</span>2048-4000797326, default 4000797326<span class=o>)</span>: +64M <span class=c1># 大小为64M的分区</span>

Created a new partition <span class=m>1</span> of <span class=nb>type</span> <span class=s1>&#39;Linux filesystem&#39;</span> and of size <span class=m>64</span> MiB.
Partition <span class=c1>#1 contains a vfat signature.</span>

Do you want to remove the signature? <span class=o>[</span>Y<span class=o>]</span>es/<span class=o>[</span>N<span class=o>]</span>o: Y

The signature will be removed by a write command.
Command <span class=o>(</span>m <span class=k>for</span> <span class=nb>help</span><span class=o>)</span>: n <span class=c1># 创建另外一个分区</span>
Partition number <span class=o>(</span>2-128, default 2<span class=o>)</span>:
First sector <span class=o>(</span>133120-4000797326, default 133120<span class=o>)</span>:
Last sector, +/-sectors or +/-size<span class=o>{</span>K,M,G,T,P<span class=o>}</span> <span class=o>(</span>133120-4000797326, default 4000797326<span class=o>)</span>: <span class=c1># 不输入默认所有</span>
Created a new partition <span class=m>2</span> of <span class=nb>type</span> <span class=s1>&#39;Linux filesystem&#39;</span> and of size 1.9 TiB.

Command <span class=o>(</span>m <span class=k>for</span> <span class=nb>help</span><span class=o>)</span>:w
The partition table has been altered.
Calling ioctl<span class=o>()</span> to re-read partition table.
Syncing disks.
</code></pre></td></tr></table></div></div><p>查看分区表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>fdisk -l
</code></pre></td></tr></table></div></div><p><img src=../../images/list_partition.png alt="List Partition"></p><p>这里分区就创建完成了。</p><h3 id=初始化文件系统>初始化文件系统</h3><p>在分区创建完成之后需要格式化成特定的文件系统挂载才能够正常使用，根据我们之前的分区规划我们来对当前的2个分区来进行初始化。</p><blockquote><p>初始化 <code>/dev/nvme0n1p1</code></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mkfs.fat -F32 /dev/nvme0n1p1
</code></pre></td></tr></table></div></div><blockquote><p>初始化 <code>/dev/nvme0n1p2</code></p></blockquote><p>这里我选择的是在LUKS上创建文件系统，所以先要初始化LUKS</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>cryptsetup luksFormat /dev/nvme0n1p2
</code></pre></td></tr></table></div></div><p><img src=../../images/format_luks.png alt="Format Luks"></p><p>这里会提示你的输入大写的<code>YES</code></p><p>然后输入你的密码，这里同样是没有回显的放心输入好了。</p><p>这里LUKS就初始化完成了，但是我们的初始化分区工作还没有完成还需要解开LUKS来对分区初始化</p><blockquote><p>打开LUKS 分区</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>cryptsetup luksOpen /dev/nvme0n1p2 system
</code></pre></td></tr></table></div></div><p>这里会提示输入密码（这个密码就是在之前初始化时候的密码）</p><p><img src=../../images/open_luks.png alt="Open Luks"></p><p>可以看到在密码正确输入之后分区被打开了，设备位置位于<code>/dev/mapper/system</code></p><blockquote><p>初始化<code>/dev/mapper/system</code></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mkfs.ext4  -i <span class=m>8192</span> /dev/mapper/system
</code></pre></td></tr></table></div></div><p>到这里分区的初始化就完成了</p><h3 id=挂载分区>挂载分区</h3><p>在完成了分区的初始化之后，就要开始挂载分区了。</p><p>首先我们创建一个挂载点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mkdir -pv /mnt/gentoo
</code></pre></td></tr></table></div></div><p>挂载分区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mount /dev/mapper/system /mnt/gentoo
</code></pre></td></tr></table></div></div><p>创建 <code>/boot</code>挂载点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mkdir -pv /mnt/gentoo/boot
</code></pre></td></tr></table></div></div><p>挂载<code>/boot</code>分区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mount /dev/nvme0n1p1 /mnt/gentoo/boot
</code></pre></td></tr></table></div></div><p>挂载目录结构如下图所示</p><p><img src=../../images/show_mount.png alt="show mount"></p><p>到这里我们就完成挂载分区了</p><h3 id=安装gentoo安装文件>安装Gentoo安装文件</h3><h4 id=设置日期和时间>设置日期和时间</h4><p>在安装Gentoo之前，我们要确保livecd里面的时间设置正确。错误的时间配置可能会导致安装包的时候抛出异常和一堆错误。</p><p>设置时区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>timedatectl set-timezone <span class=s2>&#34;Asia/Shanghai&#34;</span>
</code></pre></td></tr></table></div></div><h4 id=选择安装文件>选择安装文件</h4><p>选择对一个基础的压缩包将会为稍后的安装节省大量的时间：</p><ul><li>multilib (包含32和64位程序的兼容性)</li><li>no-multilib (只支持64位的程序)</li></ul><p>考虑到我是刚开始折腾Gentoo我这里就选择的是<code>multilib</code></p><h4 id=下载stage压缩包>下载stage压缩包</h4><p>首先进入到<code>/mnt/gentoo</code>目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>cd</span> /mnt/gentoo
</code></pre></td></tr></table></div></div><p>我这里使用的是阿里云的源你也可以选择其他的源</p><p>目录基本在<code>gentoo/releases/amd64/autobuilds/current-stage3-amd64/</code>下面</p><ul><li><a href=http://mirrors.aliyun.com/gentoo/releases/amd64/autobuilds/current-stage3-amd64/>阿里云地址</a></li></ul><p>这个下载链接可能会因为时间的关系失效，如果失效可以进入到这个目录下面选择最新的压缩包进行下载。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>wget -c http://mirrors.aliyun.com/gentoo/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-20210117T214503Z.tar.xz
wget -c http://mirrors.aliyun.com/gentoo/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-20210117T214503Z.tar.xz.DIGESTS
wget -c http://mirrors.aliyun.com/gentoo/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-20210117T214503Z.tar.xz.CONTENTS.gz
wget -c http://mirrors.aliyun.com/gentoo/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-20210117T214503Z.tar.xz.DIGESTS.asc
</code></pre></td></tr></table></div></div><p>查验压缩包的SHA512校验值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>awk <span class=s1>&#39;/SHA512 HASH/{getline;print}&#39;</span> stage3-amd64-*.tar.xz.DIGESTS.asc <span class=p>|</span> sha512sum --check
</code></pre></td></tr></table></div></div><p>确保值一致</p><p>接下来解压压缩包</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>tar xpvf stage3-*.tar.xz --xattrs-include<span class=o>=</span><span class=s1>&#39;*.*&#39;</span> --numeric-owner
</code></pre></td></tr></table></div></div><p>请确保使用的是这个解压命令（保持权限还是压缩之前的状态）</p><h3 id=portage-文件说明>Portage 文件说明</h3><p>在开始配置Portage之前我们先对Portage有哪些文件先做一下说明</p><table><thead><tr><th>在 <code>/etc/portage</code>下的文件</th><th>文件说明</th></tr></thead><tbody><tr><td>repos.conf</td><td>指定特定站点的仓库配置，包括仓库的同步机制和URL</td></tr><tr><td>make.conf</td><td>这个文件包含了Portage的各种重要的变量定义。这些变量还告诉系统：<ol><li>默认接受的许可(比如说所有软件，或者是FSF便好的免费软件 )</li><li>系统架构（比如说amd64 架构实际上是对64位处理器的通用引用无论是AMD还是Intel</li><li>关于系统显卡和输入设备的信息</li><li>设置系统是处于稳定版本还是测试版本</li><li>系统默认的全局<code>USE</code></li><li>设置Portage distfile tarball的URL 从而加速下载</li><li>构建期间的日志记录</li></ol>除此之外还有很多的配置</td></tr><tr><td>package.mask</td><td>package.mask中指定的软件将会不被安装（可以将其看成黑名单），当新版本的软件出现一些问题的时候（或者是不兼容）可以在这个文件中添加对应的记录。</td></tr><tr><td>package.unmask</td><td>这个文件的作用将会覆盖package.mask的效果（安装白名单）。</td></tr><tr><td>package.use</td><td>package.use包含单个软件包的USE标志的列表。 当指定仅具有局部含义的标志或者是在特殊情况下希望将其打开（比如说测试特性），它会派上用场</td></tr><tr><td>package.license</td><td>这个文件允许你基于每个软件包来设置许可证（比如说我想要整个系统都是free的但是某个软件例外）</td></tr><tr><td>package.accept_keywords</td><td>这个文件主要的作用是允许你使用测试而非稳定分支的包。最好少用以避免依赖污染。有的时候是必要的比如说：portage 树中没有可用的稳定软件时</td></tr><tr><td>env</td><td>这里是定义特殊的配置文件比如说只允许单核心编译<code>MAKEOPTS="-j1"</code> 这里的配置文件是给<code>package.env</code>作为引用</td></tr><tr><td>package.env</td><td>package.env 允许将上面定义的环境设置引用到特定的软件包</td></tr></tbody></table><h3 id=atoms-packages-categories-versions-sets-and-slots>Atoms, Packages, Categories, Versions, Sets and SLOTs</h3><p>这里来对Portage包管理的一些术语做一些简单的介绍</p><ul><li>软件包指的是同类软件块，每个都提供一个可以安装的ebuild，不管是额外的包还是gentoo的包。</li><li>包作为树的叶子，被分组为类别，这些类别就相当于是通过功能来划分，比如说openvpn属于net-vpn这个类别</li><li>程序的原子指的是由完整类别组成的名称，没有版本和其他的限定符号比如说 net-vpn/openvpn 什么时候会用到原子呢？比如说你要引用一个基于SQLite的数据库 <code>dev-python/axiom</code> 但是这个是和<code>sci-mathematics/axiom</code> 是一个软件包名字这个时候原子就派上用场了。</li><li>通常可以通过 packages::reponame 附加到原子上从而指定特定仓库中的ebuild来安装软件包</li><li>Portage支持一个软件的多个版本，这里是需要portage tree中存在这个软件的多个版本ebuild。</li><li>在有些时候需要打开软件包的某个特性的时候就需要修改 <code>/etc/portage/package.use</code>下面的内容，如果指定的是基本原子那就是意味着对这个程序的所有版本都应用这个USE，当然也可以指定特定版本的。可以使用这些前缀来指定特定版本的原子：<code>(">", ">=", "=", "&lt;=", "&lt;")</code> 这些将会限制原子在特定版本下的USE比如说 <code>>=net-vpn/openvpn-2.4.3 inotify</code>将这个添加到<code>/etc/portage/package.use</code>文件中这就意味着告诉Portage在openvpn大于等于2.4.3的时候启用inotify这个USE。 关于更多的原子的细节可以参考 <code>man 5 ebuild</code>。</li><li>可以将多个原子分为一组，从而可以针对整个组来进行操作（比如说重建某个组）。对于这个组有个名字：集合，集合以<code>@</code>作为前缀，其中一些是在Portage里由预先定义的比如说 <code>@system</code>集合包括主要的系统软件包。像是我们安装一个软件包（原子）这个就会记录在 <code>/var/lib/portage/world</code>中。(<code>@world</code>集合包含了<code>@system</code>集合，如果有需要还可以自己定义集合。)。</li><li>关于Gentoo的系统版本，你可能会发现Gentoo和其他发行版不太一样不像是Ubuntu有那种Xenial Xerus之类的版本，如果你有用过Archlinux之类的滚动发行版你可能会知道Gentoo也是滚动发行版。Gentoo本身就没有版本，当你更新系统的时候都会更新到最新的版本（取决于你是在稳定分支还是测试分支）。这样的好处就是当新的软件的ebuild到了portage tree的时候可以修改portage配置文件来尝试使用。但是同样的也带来一个新的问题相较于Ubuntu这样的二进制发行版，有的时候编译会不通过。</li></ul><p>是时候回到安装了！</p><h3 id=配置portage>配置Portage</h3><p>我们的第一个Portage的配置是确保 下载/拆包/准备/配置/编译/安装/合并 这个周期能够尽可能的高效，这意味着要利用系统可以提供的任何并行性。</p><p>我们需要从两个方面入手</p><ol><li>最大运行Portage的作业数量</li><li>以及每个ebuild自身调用make进程并行线程的最大数量。</li></ol><p>按照Gentoo Wiki的建议我们将会吧并发的作业数量和make线程数设置为等于系统CPU的线程数+1，当系统平均负载到达或者是超过CPU数量的时候，我们需要阻止新的作业加入或者是新的编译开始。</p><p>我们要设置的两个变量是<code>EMERGE_DEFAULT_OPTS</code>(Portage作业数控制)和<code>MAKEOPTS</code>(make的线程数)，这些通常是在<code>make.conf</code>里面定义。
因为Portage不支持命令替换之类的高级Bash功能，所以我们将会在 root 的<code>.bashrc</code>中设置。</p><blockquote><p>Tips: 一般来说，emerge是以root用户启动的，当编译的时候，emerge通常会降低特权以“portage”这个用户运行。</p></blockquote><p>用你喜欢的编辑器打开<code>/mnt/gentoo/root/.bashrc</code>文件（本教程用nano作为主要的编辑器）</p><blockquote><p>Tips: <code>-w</code> 选项是告诉<code>nano</code>编辑器不要自动换行，因为自动换行有的时候会搞乱配置文件。
nano是一个很简单的编辑器：用方向键可以上下左右移动，像是任何文本处理工具一样进行编辑，完成编辑之后使用Ctrl+x退出（按住Ctrl的同时再按x）：如果你修改了文件系统会提示你是否要保存，这个时候输入<code>y</code>再按enter退出，保存更改。输入n退出即是不保存更改退出。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w /mnt/gentoo/root/.bashrc
</code></pre></td></tr></table></div></div><p>内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>export</span> <span class=nv>NUMCPUS</span><span class=o>=</span><span class=k>$(</span>nproc<span class=k>)</span>
<span class=nb>export</span> <span class=nv>NUMCPUSPLUSONE</span><span class=o>=</span><span class=k>$((</span> NUMCPUS <span class=o>+</span> <span class=m>1</span> <span class=k>))</span>
<span class=nb>export</span> <span class=nv>MAKEOPTS</span><span class=o>=</span><span class=s2>&#34;-j</span><span class=si>${</span><span class=nv>NUMCPUSPLUSONE</span><span class=si>}</span><span class=s2> -l</span><span class=si>${</span><span class=nv>NUMCPUS</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=nb>export</span> <span class=nv>EMERGE_DEFAULT_OPTS</span><span class=o>=</span><span class=s2>&#34;--jobs=</span><span class=si>${</span><span class=nv>NUMCPUSPLUSONE</span><span class=si>}</span><span class=s2> --load-average=</span><span class=si>${</span><span class=nv>NUMCPUS</span><span class=si>}</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><p>保存并退出nano</p><blockquote><p>Tips: 如果在编译的时候遇到并行的问题希望回到更加保守的配置，可以设置上面的<code>MAKEOPTS="-j1"</code>来进行全局设定。</p></blockquote><p>接下来我们要确保<code>.bashrc</code>这个文件是root登陆的shell读取的，因此还需要复制一份默认的<code>.bash_profile</code>配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>cp -v /mnt/gentoo/etc/skel/.bash_profile /mnt/gentoo/root/
</code></pre></td></tr></table></div></div><p>接下来进入<code>make.conf</code>配置文件本身。我们安装的stage3文件已经包含了基本的配置。我们将用<code>nano</code>编辑器打开这个文件，删除现有行，然后替换我们的配置。（nano中，Ctrl+k 可以用来快速剪切当前行）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w /mnt/gentoo/etc/portage/make.conf
</code></pre></td></tr></table></div></div><p>内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># Build setup as of &lt;add current date&gt;</span>

<span class=c1># C, C++ and FORTRAN options for GCC.</span>
<span class=nv>COMMON_FLAGS</span><span class=o>=</span><span class=s2>&#34;-march=native -O2 -pipe&#34;</span>
<span class=nv>CFLAGS</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>COMMON_FLAGS</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=nv>CXXFLAGS</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>COMMON_FLAGS</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=nv>FCFLAGS</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>COMMON_FLAGS</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=nv>FFLAGS</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>COMMON_FLAGS</span><span class=si>}</span><span class=s2>&#34;</span>

<span class=c1># Note: MAKEOPTS and EMERGE_DEFAULT_OPTS are set in .bashrc</span>

<span class=c1># The following licence is required.</span>
<span class=nv>ACCEPT_LICENSE</span><span class=o>=</span><span class=s2>&#34;*&#34;</span>

<span class=c1># WARNING: Changing your CHOST is not something that should be done lightly.</span>
<span class=c1># Please consult http://www.gentoo.org/doc/en/change-chost.xml before changing.</span>
<span class=nv>CHOST</span><span class=o>=</span><span class=s2>&#34;x86_64-pc-linux-gnu&#34;</span>

<span class=c1># Use the &#39;stable&#39; branch - &#39;testing&#39; no longer required for Gnome 3.</span>
<span class=c1># NB, amd64 is correct for both Intel and AMD 64-bit CPUs</span>
<span class=nv>ACCEPT_KEYWORDS</span><span class=o>=</span><span class=s2>&#34;amd64&#34;</span>

<span class=c1># Additional USE flags supplementary to those specified by the current profile.</span>
<span class=nv>USE</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
<span class=nv>CPU_FLAGS_X86</span><span class=o>=</span><span class=s2>&#34;mmx mmxext sse sse2&#34;</span>

<span class=c1># Important Portage directories.</span>
<span class=nv>PORTDIR</span><span class=o>=</span><span class=s2>&#34;/var/db/repos/gentoo&#34;</span>
<span class=nv>DISTDIR</span><span class=o>=</span><span class=s2>&#34;/var/cache/distfiles&#34;</span>
<span class=nv>PKGDIR</span><span class=o>=</span><span class=s2>&#34;/var/cache/binpkgs&#34;</span>

<span class=c1># Distfile Mirrors</span>
<span class=nv>GENTOO_MIRRORS</span><span class=o>=</span><span class=s2>&#34;https://mirrors.aliyun.com/gentoo&#34;</span>

<span class=c1># GRUB Platforms</span>
<span class=nv>GRUB_PLATFORMS</span><span class=o>=</span><span class=s2>&#34;efi-64&#34;</span>

<span class=c1># ABI Version</span>
<span class=nv>ABI_X86</span><span class=o>=</span><span class=s2>&#34;64&#34;</span>
<span class=c1># This sets the language of build output to English.</span>
<span class=c1># Please keep this setting intact when reporting bugs.</span>
<span class=nv>LC_MESSAGES</span><span class=o>=</span>C

<span class=c1># Turn on logging - see http://gentoo-en.vfose.ru/wiki/Gentoo_maintenance.</span>
<span class=nv>PORTAGE_ELOG_CLASSES</span><span class=o>=</span><span class=s2>&#34;info warn error log qa&#34;</span>
<span class=c1># Echo messages after emerge, also save to /var/log/portage/elog</span>
<span class=nv>PORTAGE_ELOG_SYSTEM</span><span class=o>=</span><span class=s2>&#34;echo save&#34;</span>

<span class=c1># Ensure elogs saved in category subdirectories.</span>
<span class=c1># Build binary packages as a byproduct of each emerge, a useful backup.</span>
<span class=nv>FEATURES</span><span class=o>=</span><span class=s2>&#34;split-elog buildpkg&#34;</span>

<span class=c1># Settings for X11</span>
<span class=nv>VIDEO_CARDS</span><span class=o>=</span><span class=s2>&#34;intel i965&#34;</span>
<span class=nv>INPUT_DEVICES</span><span class=o>=</span><span class=s2>&#34;libinput wacom synaptics&#34;</span>
</code></pre></td></tr></table></div></div><blockquote><p>Tips: 在<code>/etc/portage/make.conf</code>中给你的系统设置特定的<code>VIDEO_CARDS</code>和<code>INPUT_DEVICES</code>。参见下边的这张表</p></blockquote><p>保存并退出nano</p><p>这里是刚开始的stage3文件中包含的<code>make.conf</code>配置简要，以及我们所添加的。</p><table><thead><tr><th>变量</th><th>类型</th><th>默认值</th><th>我们设置的值</th><th>描述</th></tr></thead><tbody><tr><td>COMMON_FLAGS</td><td>Standard</td><td>-O2 -pipe</td><td>-march=native -O2 -pipe</td><td>这个变量仅定义一些通用的标志，这些标志会传给GNU编译器，在编译源码的时候使用，缺省值为 <code>-O2</code>，这是它推荐设置的级别（以较小的编译时间为代价，生成更小，更快的代码），以及<code>-pipe</code>，它指示编译器在可能的情况下更多的使用管道而不是临时文件从而加快编译速度。我们保留这些添加了<code>-march=native</code>。这个会自动检查CPU的类型，并且会利用CPU其特性生成代码。需要注意的是在这个设置了情况下编译的软件在其他的计算机是很可能无法使用的！</td></tr><tr><td>CFLAGS</td><td>Standard</td><td><code>${COMMON_FLAGS}</code></td><td><code>${COMMON_FLAGS}</code></td><td>这个变量设置在编译C代码时的编译器标志</td></tr><tr><td>CXXFLAGS</td><td>Standard</td><td><code>${COMMON_FLAGS}</code></td><td><code>${COMMON_FLAGS}</code></td><td>这个变量设置在编译C++ 代码时候的编译器标志</td></tr><tr><td>FCFLAGS</td><td>Standard</td><td><code>${COMMON_FLAGS}</code></td><td><code>${COMMON_FLAGS}</code></td><td>将CPU标志传给FORTRAN编译器</td></tr><tr><td>FFLAGS</td><td>Standard</td><td><code>${COMMON_FLAGS}</code></td><td><code>${COMMON_FLAGS}</code></td><td>将CPU标志传给 FORTRAN77编译器</td></tr><tr><td>ACCEPT_LICENSE</td><td>Incremental</td><td><code>-* @FREE</code></td><td><code>*</code></td><td>接受所有许可的软件</td></tr><tr><td>CHOST</td><td>Standard</td><td>x86_64-pc-linux-gnu</td><td>x86_64-pc-linux-gnu</td><td>CHOST变量非常重要。 它是Architecture-vendor-operating_system-C_library的元组，用于控制构建过程。这里我们不会进行更改。</td></tr><tr><td>ACCEPT_KEYWORDS</td><td>Incremental</td><td>amd64</td><td>amd64</td><td>这个变量就是控制你的系统是稳定版本还是非稳定版本 <code>amd64</code>就是处于稳定分支的系统只接受上游测试通过的软件包 <code>~amd64</code>就是测试版本接受最新的ebuild 即使可能不稳定。</td></tr><tr><td>USE</td><td>Incremental</td><td>various flags set by profile</td><td>empty</td><td>默认的stage3是有一个bindist的USE的这里留空，使用profile的默认USE</td></tr><tr><td>CPU_FLAGS_X86</td><td>USE_EXPAND</td><td>mmx mmxext sse sse2</td><td>mmx mmxext sse sse2</td><td>这个变量告诉Portage 使用哪个处理器的特定标志（比如说启动MMX的支持），我们这里保留默认的配置在章节中我们会使用<code>app-portage/cpuinfo2cpuflags</code>这个包自动为我们生成适合优化的配置。</td></tr><tr><td>PORTDIR</td><td>Standard</td><td><code>/var/db/repos/gentoo</code></td><td><code>/var/db/repos/gentoo</code></td><td>这个变量定义了Portage树的位置，这里我们保持原样。</td></tr><tr><td>DISTDIR</td><td>Standard</td><td><code>/var/cache/distfiles</code></td><td><code>/var/cache/distfiles</code></td><td>这个变量定义了存储源码包的tarball位置，这里我们保持原样。</td></tr><tr><td>PKGDIR</td><td>Standard</td><td><code>/var/cache/binpkgs</code></td><td><code>/var/cache/binpkgs</code></td><td>这个变量定义了存储二进制包的位置，这里我们保持原样。</td></tr><tr><td>LC_MESSAGES</td><td>Standard</td><td><code>C</code></td><td><code>C</code></td><td>这个变量用于设置编译时候输出的语言。我们这里设置为C（表示英文输出），这是提交编译报错时必须的，但是你也可以根据自己的需要来更改方便你的使用</td></tr><tr><td>PORTAGE_ELOG_CLASSES</td><td>Standard</td><td>absent</td><td>info warn error log qa</td><td>这个变量告诉Portage要记录哪些ebuild信息，我们这里的设置为打开所有信息。</td></tr><tr><td>PORTAGE_ELOG_SYSTEM</td><td>Standard</td><td>absent</td><td>echo save</td><td>这个变量指示Portage处理日志消息，在这个设置下日志将会输出回显，并保存。</td></tr><tr><td>FEATURES</td><td>Incremental</td><td>various features set by profile</td><td>split-elog buildpkg</td><td>顾名思义，这个变量用于打开或者是关闭Portage的功能。我们打开了split-elog，确保日志会存在 <code>/var/log/portage/elog</code>的子目录中，同时我们也打开了 buildpkg的功能，这个是在构建成功软件包的时候保存一份二进制版本到之前设置的PKGDIR中。</td></tr><tr><td>VIDEO_CARDS</td><td>USE_EXPAND</td><td>comprehensive list of video cards set by profile</td><td>intel i965</td><td>这个变量就是告诉各种程序在你的系统里面是什么显卡。我在这里制定了 intel i965这么几个驱动（这个也是在Mac上测试通过可以正常启动X的情况）</td></tr><tr><td>INPUT_DEVICES</td><td>USE_EXPAND</td><td>various input devices set by profile</td><td>libinput wacom synaptics</td><td>这个变量是告诉X Windows我们需要支持哪些输入设备。</td></tr></tbody></table><h3 id=chroot>Chroot</h3><h4 id=chroot的最终准备>Chroot的最终准备</h4><p>我们需要创建并配置一个文件，这个文件<code>/mnt/gentoo/etc/portage/repos.conf/gentoo.conf</code>将会告诉Portage从哪里获取最新的Portage树。</p><p>首先我们需要创建文件夹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mkdir -p -v /mnt/gentoo/etc/portage/repos.conf
cp -v /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
nano -w /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
</code></pre></td></tr></table></div></div><p>修改内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=o>[</span>DEFAULT<span class=o>]</span>
main-repo <span class=o>=</span> gentoo

<span class=o>[</span>gentoo<span class=o>]</span>
<span class=nv>location</span> <span class=o>=</span> /var/db/repos/gentoo
sync-type <span class=o>=</span> webrsync
<span class=c1>#sync-type = rsync</span>
sync-uri <span class=o>=</span> rsync://rsync.mirrors.aliyun.com/gentoo-portage/gentoo-portage/
sync-webrsync-verify-signature <span class=o>=</span> <span class=nb>true</span>
auto-sync <span class=o>=</span> yes

sync-rsync-verify-jobs <span class=o>=</span> <span class=m>1</span>
sync-rsync-verify-metamanifest <span class=o>=</span> yes
sync-rsync-verify-max-age <span class=o>=</span> <span class=m>24</span>
sync-openpgp-keyserver <span class=o>=</span> hkps://keys.gentoo.org
sync-openpgp-key-path <span class=o>=</span> /usr/share/openpgp-keys/gentoo-release.asc
sync-openpgp-key-refresh-retry-count <span class=o>=</span> <span class=m>40</span>
sync-openpgp-key-refresh-retry-overall-timeout <span class=o>=</span> <span class=m>1200</span>
sync-openpgp-key-refresh-retry-delay-exp-base <span class=o>=</span> <span class=m>2</span>
sync-openpgp-key-refresh-retry-delay-max <span class=o>=</span> <span class=m>60</span>
sync-openpgp-key-refresh-retry-delay-mult <span class=o>=</span> <span class=m>4</span>
</code></pre></td></tr></table></div></div><p>保存并退出</p><p>上面这个配置文件说明了以下内容：</p><p>设置主要的仓库为gentoo
存储位置是在 <code>/var/db/repos/gentoo</code>
同步方式为websync（之后会改为增量的 rsync）</p><p>接下来我们要确保chroot之后还可以使用这个Mac的网络，也就是我们需要复制一下 <code>/etc/resolv.conf</code>配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>cp -v -L /etc/resolv.conf /mnt/gentoo/etc/
</code></pre></td></tr></table></div></div><p>-L选项可确保我们不会错误地复制符号链接，因为一旦chroot，主机文件系统将变得不可访问。</p><p>然后，我们还需要确保 chroot 之后还可以使用 <code>/proc</code>, <code>/sys</code>, <code>/dev/</code>,这些特殊的文件系统</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mount -v -t proc none /mnt/gentoo/proc
mount -v --rbind /sys /mnt/gentoo/sys
mount -v --rbind /dev /mnt/gentoo/dev
mount -v --make-rslave /mnt/gentoo/sys
mount -v --make-rslave /mnt/gentoo/dev
</code></pre></td></tr></table></div></div><blockquote><p>Tips： 在非Gentoo官方的Livecd中 <code>/dev/shm</code>可能被连接到了<code>/run/shm</code>还需要运行以下命令</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>test</span> -L /dev/shm <span class=o>&amp;&amp;</span> rm /dev/shm <span class=o>&amp;&amp;</span> mkdir /dev/shm
mount --types tmpfs --options nosuid,nodev,noexec shm /dev/shm
chmod <span class=m>1777</span> /dev/shm
</code></pre></td></tr></table></div></div><h4 id=进入chroot>进入chroot</h4><p>这里进入chroot的准备工作就完成了，我们现在就可以进入chroot了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>chroot /mnt/gentoo /bin/bash
</code></pre></td></tr></table></div></div><p>进入chroot之后可能遇到命令无法执行的情况我们需要执行以下操作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>source</span> /etc/profile
<span class=nb>export</span> <span class=nv>PS1</span><span class=o>=</span><span class=s2>&#34;(chroot) </span><span class=nv>$PS1</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><blockquote><p>我们设置了一个<code>PS1</code>这个方便区分我们当前是在什么环境</p></blockquote><h3 id=安装和更新portage-tree>安装和更新Portage Tree</h3><p>在这里我们要安装Portage树的快照，通知Portage可以安装哪些文件，可用的配置文件等等。</p><p>为了安全起见，我们需要更新必要的公共密钥，然后下载并验证最新的快照，运行以下命令即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emaint sync --auto
</code></pre></td></tr></table></div></div><p>现在我们有了基本的portage树，我们可以切换到rsync协议，使其保持更新的状态：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w /etc/portage/repos.conf/gentoo.conf
</code></pre></td></tr></table></div></div><p>将<code>sync-type</code>改为<code>rsync</code>注销掉原来的那行 <code>webrsync</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1>#sync-type = webrsync</span>
sync-type <span class=o>=</span> rsync
sync-uri <span class=o>=</span> rsync://mirrors.aliyun.com/gentoo-portage/gentoo-portage/
</code></pre></td></tr></table></div></div><p>再次同步</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emaint sync --auto
</code></pre></td></tr></table></div></div><blockquote><p>有的时候会遇到源不可用的情况，这里再补充一种利用git同步Portage tree的配置。</p></blockquote><p>在完成了第一次<code>webrsync</code>同步之后安装git包</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask  dev-vcs/git
</code></pre></td></tr></table></div></div><p>再去修改配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w /etc/portage/repos.conf/gentoo.conf
</code></pre></td></tr></table></div></div><p>内容更改如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=o>[</span>DEFAULT<span class=o>]</span>
main-repo <span class=o>=</span> gentoo

<span class=o>[</span>gentoo<span class=o>]</span>
<span class=nv>location</span> <span class=o>=</span> /var/db/repos/gentoo
sync-type <span class=o>=</span> git
sync-uri <span class=o>=</span> https://github.com/gentoo-mirror/gentoo.git
auto-sync <span class=o>=</span> yes
</code></pre></td></tr></table></div></div><p>保存退出后我们需要将原来的目录删除</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>rm -rf /var/db/repos/gentoo
</code></pre></td></tr></table></div></div><p>再次进行同步</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emaint sync --auto
</code></pre></td></tr></table></div></div><h3 id=设置基本的配置文件>设置基本的配置文件</h3><p>像是之前所说到的Gentoo使用配置文件来设置特定的架构和使用场景。配置文件还限制了可以安装的可以安装软件包的版本，默认的USE之类的，这个基本的profile是由Gentoo开发者来维护的。</p><p>这里我们检查一下是否在17.1 amd64配置文件即可，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>eselect profile list
Available profile symlink targets:
  <span class=o>[</span>1<span class=o>]</span>   default/linux/amd64/17.1 <span class=o>(</span>stable<span class=o>)</span> *
  <span class=o>[</span>2<span class=o>]</span>   default/linux/amd64/17.1/selinux <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>3<span class=o>]</span>   default/linux/amd64/17.1/hardened <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>4<span class=o>]</span>   default/linux/amd64/17.1/hardened/selinux <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>5<span class=o>]</span>   default/linux/amd64/17.1/desktop <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>6<span class=o>]</span>   default/linux/amd64/17.1/desktop/gnome <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>7<span class=o>]</span>   default/linux/amd64/17.1/desktop/gnome/systemd <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>8<span class=o>]</span>   default/linux/amd64/17.1/desktop/plasma <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>9<span class=o>]</span>   default/linux/amd64/17.1/desktop/plasma/systemd <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>10<span class=o>]</span>  default/linux/amd64/17.1/desktop/systemd <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>11<span class=o>]</span>  default/linux/amd64/17.1/developer <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>12<span class=o>]</span>  default/linux/amd64/17.1/no-multilib <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>13<span class=o>]</span>  default/linux/amd64/17.1/no-multilib/hardened <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>14<span class=o>]</span>  default/linux/amd64/17.1/no-multilib/hardened/selinux <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>15<span class=o>]</span>  default/linux/amd64/17.1/systemd <span class=o>(</span>stable<span class=o>)</span>
  <span class=o>[</span>16<span class=o>]</span>  default/linux/amd64/17.0 <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>17<span class=o>]</span>  default/linux/amd64/17.0/selinux <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>18<span class=o>]</span>  default/linux/amd64/17.0/hardened <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>19<span class=o>]</span>  default/linux/amd64/17.0/hardened/selinux <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>20<span class=o>]</span>  default/linux/amd64/17.0/desktop <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>21<span class=o>]</span>  default/linux/amd64/17.0/desktop/gnome <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>22<span class=o>]</span>  default/linux/amd64/17.0/desktop/gnome/systemd <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>23<span class=o>]</span>  default/linux/amd64/17.0/desktop/plasma <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>24<span class=o>]</span>  default/linux/amd64/17.0/desktop/plasma/systemd <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>25<span class=o>]</span>  default/linux/amd64/17.0/developer <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>26<span class=o>]</span>  default/linux/amd64/17.0/no-multilib <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>27<span class=o>]</span>  default/linux/amd64/17.0/no-multilib/hardened <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>28<span class=o>]</span>  default/linux/amd64/17.0/no-multilib/hardened/selinux <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>29<span class=o>]</span>  default/linux/amd64/17.0/systemd <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>30<span class=o>]</span>  default/linux/amd64/17.0/x32 <span class=o>(</span>dev<span class=o>)</span>
  <span class=o>[</span>31<span class=o>]</span>  default/linux/amd64/17.0/musl <span class=o>(</span>exp<span class=o>)</span>
  <span class=o>[</span>32<span class=o>]</span>  default/linux/amd64/17.0/musl/hardened <span class=o>(</span>exp<span class=o>)</span>
  <span class=o>[</span>33<span class=o>]</span>  default/linux/amd64/17.0/musl/hardened/selinux <span class=o>(</span>exp<span class=o>)</span>
  <span class=o>[</span>34<span class=o>]</span>  default/linux/amd64/17.0/uclibc <span class=o>(</span>exp<span class=o>)</span>
  <span class=o>[</span>35<span class=o>]</span>  default/linux/amd64/17.0/uclibc/hardened <span class=o>(</span>exp<span class=o>)</span>
</code></pre></td></tr></table></div></div><p>在这里我们的默认配置文件已经在这个profile文件，如果你想要手动选一下可以使用<code>eselect</code>工具来设置配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>eselect profile <span class=nb>set</span> <span class=s2>&#34;default/linux/amd64/17.1&#34;</span>
</code></pre></td></tr></table></div></div><p>你可以通过这条命令来查看配置文件<code>make.conf</code>环境，这个在提交bug的时候最好也附加上去</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --info
</code></pre></td></tr></table></div></div><p>如果你对USE标志的含义不是很理解可以通过下面这条命令去查找其含义（比如说<code>useflag</code>）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>grep -i useflag /var/db/repos/gentoo/profiles/use.desc
</code></pre></td></tr></table></div></div><p>或者是<a href=https://packages.gentoo.org/useflags/search>在线查询</a></p><h4 id=确保更新了portage>确保更新了Portage</h4><p>在完成了更新portage tree的时候portage提示Portage有可用的更新了，可以通过这条命令来更新Portage</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose --oneshot portage
</code></pre></td></tr></table></div></div><p><code>--oneshot</code>选项是通知Portage不要把自己记录在<code>world</code>文件
<code>--ask-verbose</code>选项是emerge在对系统进行任何更改之前通知你，并产生详细的输出（可以简写为 <code>-av</code>）。
按回车进行更新</p><p>更新Portage树的同时也会带来一些新闻条目，这些发布的新闻条目最好是阅读一下，这些是很重要的，这些通常是Gentoo开发者对用户发布的简单公告，如果想要查看当前的新闻条目可以运行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>eselect news list
</code></pre></td></tr></table></div></div><p>你会注意到有新闻的编号，假如你想要阅读新闻N，可以输入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>eselect news <span class=nb>read</span> N
</code></pre></td></tr></table></div></div><p>如果你已经看完了所有的新闻，你可以运行这条命令来清除已经阅读过的新闻</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>eselect news purge
</code></pre></td></tr></table></div></div><h3 id=设置时区和语言环境>设置时区和语言环境</h3><p>我们还没有设置时区和语言环境，我们现在来设置这些。</p><p>首先是时区设置。你可以在<code>/usr/share/zoneinfo/</code>下面找到你所在位置的对应时区（这里比如说亚洲上海时区）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>echo</span> <span class=s2>&#34;Asia/Shanghai&#34;</span> &gt; /etc/timezone
</code></pre></td></tr></table></div></div><p>现在我们需要重新配置<code>sys-libs/timezone-data</code>包，重建这个包将会从<code>/etc/timezone</code>中取值，并在<code>/etc/localtime</code>中反应正确的值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge -v --config sys-libs/timezone-data
</code></pre></td></tr></table></div></div><p>其次我们必须设置合适的语言环境，我们必须要在<code>/etc/locale.gen</code>中指定要使用的语言环境。编辑这个文件，并添加以下内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w /etc/locale.gen
</code></pre></td></tr></table></div></div><p>这里我们以英文和中文为例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>en_US.UTF-8 UTF-8
zh_CN.UTF-8 UTF-8
</code></pre></td></tr></table></div></div><p>保存并退出文件。</p><p>接下来我们必须要基于<code>/etc/locale.gen</code>文件中的配置，运行<code>locale.gen</code>来创建语言环境：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>locale-gen
</code></pre></td></tr></table></div></div><p>在运行成功之后，我们还需要指定以后默认使用的语言环境，使用下面这条命令来查找当前的系统有的语言环境</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>eselect locale list
Available targets <span class=k>for</span> the LANG variable:
  <span class=o>[</span>1<span class=o>]</span>   C
  <span class=o>[</span>2<span class=o>]</span>   C.utf8
  <span class=o>[</span>3<span class=o>]</span>   POSIX
  <span class=o>[</span>4<span class=o>]</span>   en_US.utf8
  <span class=o>[</span>5<span class=o>]</span>   zh_CN.utf8
  <span class=o>[</span>6<span class=o>]</span>   C.UTF8 *
  <span class=o>[</span> <span class=o>]</span>   <span class=o>(</span>free form<span class=o>)</span>
</code></pre></td></tr></table></div></div><p>我们现在先保持为C环境，后面再修改成实际的语言环境</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>eselect locale <span class=nb>set</span> <span class=s2>&#34;C&#34;</span>
</code></pre></td></tr></table></div></div><p>现在重新载入环境</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>env-update <span class=o>&amp;&amp;</span> <span class=nb>source</span> /etc/profile <span class=o>&amp;&amp;</span> <span class=nb>export</span> <span class=nv>PS1</span><span class=o>=</span><span class=s2>&#34;(chroot) </span><span class=nv>$PS1</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><h3 id=通知portage使用特定的cpu功能>通知Portage使用特定的CPU功能</h3><p>在之前配置<code>/etc/portage/make.conf</code>中我们把<code>CPU_FLAGS_X86</code>设置成默认的值<code>mmx mmxext sse sse2</code>，在这里我们将会用到<code> app-portage/cpuid2cpuflags</code>这个工具来设置对应的变量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --verbose --oneshot app-portage/cpuid2cpuflags
</code></pre></td></tr></table></div></div><p>安装完成之后，运行这个工具并且记录下输出（你运行的输出可能和我的不太一样，这个输出取自我这台Mac）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>cpuid2cpuflags
CPU_FLAGS_X86: aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt rdrand sse sse2 sse3 sse4_1 sse4_2 ssse3
</code></pre></td></tr></table></div></div><p>然后修改<code>/etc/portage/make.conf</code>文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w /etc/portage/make.conf
</code></pre></td></tr></table></div></div><p>内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nv>CPU_FLAGS_X86</span><span class=o>=</span><span class=s2>&#34;aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt rdrand sse sse2 sse3 sse4_1 sse4_2 ssse3&#34;</span>
</code></pre></td></tr></table></div></div><p>保存并退出。</p><h3 id=gentoo-bootstrap-从stage1到stage2>Gentoo Bootstrap: 从Stage1到Stage2</h3><p>首先我们要构建自己的工具链！
Gentoo Portage Tree里面提供了一个<code>bootstrap.sh</code>脚本。
现在我们切换到脚本存在的目录：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>cd</span> /var/db/repos/gentoo/scripts
</code></pre></td></tr></table></div></div><p>然后运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>./bootstrap.sh --pretend
Gentoo Linux<span class=p>;</span> http://www.gentoo.org/
Copyright 1999-2020 Gentoo Authors<span class=p>;</span> Distributed under the GPLv2
-------------------------------------------------------------------------------
  <span class=o>[[</span> <span class=o>(</span>0/3<span class=o>)</span> Locating packages <span class=o>]]</span>
 * Using baselayout : &gt;<span class=o>=</span>sys-apps/baselayout-2
 * Using portage    : sys-apps/portage
 * Using os-headers : &gt;<span class=o>=</span>sys-kernel/linux-headers-5.4-r1
 * Using binutils   : sys-devel/binutils
 * Using gcc        : sys-devel/gcc
 * Using gettext    : sys-devel/gettext
 * Using libc       : sys-libs/glibc:2.2
 * Using texinfo    : sys-apps/texinfo
 * Using zlib       : sys-libs/zlib
 * Using ncurses    : sys-libs/ncurses
-------------------------------------------------------------------------------
  <span class=o>[[</span> <span class=o>(</span>1/3<span class=o>)</span> Configuring environment <span class=o>]]</span>
-------------------------------------------------------------------------------
  <span class=o>[[</span> <span class=o>(</span>2/3<span class=o>)</span> Updating portage <span class=o>]]</span>
!!! CONFIG_PROTECT is empty
</code></pre></td></tr></table></div></div><blockquote><p>注意这里输出的版本可能和你的不一样</p></blockquote><p>Gentoo FAQ建议是先查看这个并编辑，接下来我们也会这么做，这里面也存在几个问题：</p><ol><li>对于现代的GCC，我们需要添加一个<code>openmp</code>的USE。</li><li><code>CONFIG_PROTECT</code>为空表示在这个<code>bootstrap</code>过程中配置文件将会被覆盖。</li></ol><blockquote><ol><li>修复GCC的USE问题</li></ol></blockquote><p>使用nano打开<code>/var/db/repos/gentoo/scripts/bootstrap.sh</code>文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w /var/db/repos/gentoo/scripts/bootstrap.sh
</code></pre></td></tr></table></div></div><p>按Ctrl+w输入<code>export USE="-</code>按Enter进行搜索</p><p>修改这行内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>export</span> <span class=nv>USE</span><span class=o>=</span><span class=s2>&#34;-* bootstrap </span><span class=si>${</span><span class=nv>ALLOWED_USE</span><span class=si>}</span><span class=s2> </span><span class=si>${</span><span class=nv>BOOTSTRAP_USE</span><span class=si>}</span><span class=s2> openmp&#34;</span>
</code></pre></td></tr></table></div></div><p>保存并退出</p><blockquote><ol start=2><li>做配置文件备份</li></ol></blockquote><p>我们可以使用<code>qfile</code>来查询我们已经修改过的文件属于那个程序，以及这次重构是否会影响到，如果影响到我们就需要进行备份。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>qfile /etc/locale.gen
sys-libs/glibc: /etc/locale.gen
</code></pre></td></tr></table></div></div><p>这里我们的重构会影响到这个glibc，所以我们要对更改的文件做一个备份。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>cp -v /etc/locale.gen<span class=o>{</span>,.bak<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>现在一切就绪，让我们开始真正的<code>bootstrap</code>程序吧</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>./bootstrap.sh
</code></pre></td></tr></table></div></div><p>在<code>bootstrap.sh</code>完成之后，我们还需要检查一下GCC的配置，因为在之前的重新构建编译器过程中，可能Portage Tree中有新的可用版本构建的就是新的GCC。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>gcc-config --list-profiles
 <span class=o>[</span>1<span class=o>]</span> x86_64-pc-linux-gnu-9.3.0 *
</code></pre></td></tr></table></div></div><p>这里看起来只有一个配置，如果你选择的是测试分支(<code>~amd64</code>)可能会有多个可用的GCC版本
你可以运行这条命令来切换到最新的GCC</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>gcc-config <span class=m>1</span> <span class=c1># 这个1 就是最新版本的GCC 前面的那个1</span>
</code></pre></td></tr></table></div></div><p>还需要更新环境</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>env-update <span class=o>&amp;&amp;</span> <span class=nb>source</span> /etc/profile <span class=o>&amp;&amp;</span> <span class=nb>export</span> <span class=nv>PS1</span><span class=o>=</span><span class=s2>&#34;(chroot) </span><span class=nv>$PS1</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><p>如果你的输出是只有一个GCC那么这些是不用再去操作的。</p><blockquote><p>如果你更新了GCC你还需要做这些</p></blockquote><p>再备份一次glibc的配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>cp -v /etc/locale.gen<span class=o>{</span>,.bak<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>现在我们需要再运行一次<code>bootstrap.sh</code>脚本，以确保使用新的编译器重新构建了工具链中的所有内容，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>./bootstrap.sh
</code></pre></td></tr></table></div></div><p>完成<code>bootstrap.sh</code>之后，我们需要还原备份的配置文件，然后重新生成语言环境</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mv -v /etc/locale.gen<span class=o>{</span>.bak,<span class=o>}</span>
locale-gen
</code></pre></td></tr></table></div></div><p>现在再来检查语言环境是否是<code>C</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>eselect locale show
</code></pre></td></tr></table></div></div><p>最后返回 <code>/</code> 目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>cd</span> /
</code></pre></td></tr></table></div></div><h3 id=gentoo-bootstrap-从stage2到stage3>Gentoo Bootstrap 从Stage2到Stage3</h3><p>现在我们需要使用我们在上面构建出来的全新工具链来构建<code>@world</code>集合里面的所有包。</p><p>在开始之前我们还需要创建一个空的<code>timestamp</code>文件，这个文件可以用于在构建完成之后检查可执行文件和库被重建，并且对这些进行标记。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>touch /tmp/prebuild_checkpoint
</code></pre></td></tr></table></div></div><p>现在我们已经准备好重新构建<code>@world</code>集合中的所有内容，运行这条命令开始构建：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose --emptytree --with-bdeps<span class=o>=</span>y @world
</code></pre></td></tr></table></div></div><blockquote><p>别忘了回车开始构建。
这里是关于我们上述这条命令的解释</p></blockquote><table><thead><tr><th>参数</th><th>简写</th><th>描述</th></tr></thead><tbody><tr><td><code>--ask</code></td><td><code>-a</code></td><td>在开始之前，会显示会发生什么（比如说升级降级卸载slot等），然后询问你是否继续还是终止，这个选项建议每次使用都保留</td></tr><tr><td><code>--verbose</code></td><td><code>-v</code></td><td>提供<code>emerge</code>操作的更多信息。（比如说<code>--ask</code>提供的信息中每个包的USE标记）</td></tr><tr><td><code>--emptytree</code></td><td><code>-e</code></td><td>编译并安装所有的包(在这里安装的是<code>@world</code>这个集合里面所包含的所有包以及其相应的依赖关系)。这里是让在计算依赖关系的时候假设系统没有任何的包</td></tr><tr><td><code>--with-bdeps=y</code></td><td>N/A</td><td>将编译时依赖关系也考虑进来，从而让依赖关系树更加完整。</td></tr><tr><td><code>@world</code></td><td>N/A</td><td>这里指定是<code>@world</code>集合 <code>@</code>标记后面加上集合的名称就表示引用的是一个集合的软件包而非单个包（原子）</td></tr></tbody></table><blockquote><p>Tips: 这个操作将会持续相当长的时间，建议使用会话管理的工具来去保存构建工作
推荐使用<code>screen</code>或者是<code>tmux</code></p></blockquote><blockquote><p>Screen安装和使用</p></blockquote><p>这里只介绍非常基本的使用，想要了解更多的<code>screen</code>用法可以查阅<code>man</code>手册</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose --oneshot app-misc/screen
</code></pre></td></tr></table></div></div><p>安装完成之后，我们要创建一个会话来保存我们的构建工作</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>screen -S rebuild
</code></pre></td></tr></table></div></div><p>这里就会进入一个名为<code>rebuild</code>的会话中，运行重新构建<code>@world</code>集合。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose --emptytree --with-bdeps<span class=o>=</span>y @world
</code></pre></td></tr></table></div></div><p>现在我们可以使用Ctrl+a 再按D 保存这个会话并且回到原来的会话。</p><p>如果你想要回到这个<code>rebuild</code>会话可以输入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>screen -R rebuild
</code></pre></td></tr></table></div></div><p>这样就回到<code>rebuild</code>也就是正在构建<code>@world</code>这个会话查看进度如何。</p><blockquote><p>Tmux 安装和使用</p></blockquote><p>Tmux也是一个会话管理，我日常使用比较多的也是tmux这里也简单介绍一下tmux的简单使用</p><p>安装tmux</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose --oneshot app-misc/tmux
</code></pre></td></tr></table></div></div><p>创建一个名为<code>rebuild</code>会话</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>tmux new -A -s rebuild
</code></pre></td></tr></table></div></div><p>运行重新构建<code>@world</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose --emptytree --with-bdeps<span class=o>=</span>y @world
</code></pre></td></tr></table></div></div><p>运行Ctrl-b +d 脱离会话，回到当前的shell中，如果想要重新连接到这个会话可以运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>tmux attach -t rebuild
</code></pre></td></tr></table></div></div><p>经过长时间的构建我们终于从Stage2构建到了Stage3，这里可能有一些包已经经过升级了，如果你想要卸载掉旧的包可以执行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --depclean
</code></pre></td></tr></table></div></div><p>或者想要再来一次可以执行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --depclean <span class=o>&amp;&amp;</span> emerge --ask --verbose --emptytree --with-bdeps<span class=o>=</span>y @world
</code></pre></td></tr></table></div></div><h3 id=验证bootstrap>验证bootstrap</h3><p>首先恭喜你完成了bootstrap，当前chroot环境里面的所有二进制文件，库都被重新构建了。这里为了确保没有遗漏的包的发生，我们要对之前创建的时间戳文件进行检查。</p><p>运行这条命令（可能需要耗费一些时间）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>find / -type d -path /boot -prune -o -path /proc -prune -o -type f -executable -not -newer /tmp/prebuild_checkpoint -print0 2&gt;/dev/null <span class=p>|</span> xargs -0 file --no-pad --separator<span class=o>=</span><span class=s2>&#34;@@@&#34;</span> <span class=p>|</span> grep -iv <span class=s1>&#39;@@@.* text&#39;</span>
</code></pre></td></tr></table></div></div><p>这个命令会查找所有可执行的文件。它不会产生输出（如果我们的bootstrap重建完成会重新创建所有这类文件）。</p><p>对于可执行的二进制文件来说太多了（动态库，静态库），我们已经检查了大多数的共享库，因为它们的执行位已经设置过了，但是相对于那些静态库和对象文件我们还没有设置位还需要运行另外一个测试</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>find / -type d -path /boot -prune -o -path /proc -prune -o -type f -not -executable -not -newer /tmp/prebuild_checkpoint -print0 2&gt;/dev/null <span class=p>|</span> xargs -0 file --no-pad --separator<span class=o>=</span><span class=s2>&#34;@@@&#34;</span> <span class=p>|</span> grep <span class=s1>&#39;@@@.*\( ELF\| ar archive\)&#39;</span>
</code></pre></td></tr></table></div></div><p>这个测试同样会耗费一些时间请耐心等待。</p><h3 id=切换配置文件>切换配置文件</h3><p>在完成bootstrap之后我们要再去选择一个自己喜欢的配置文件。
这里我不打算上DE(Desktop environment)，打算上WM（节省更多的内存可以用于做实验或者是其他）。
所以我这里选择的profile是desktop的profile，用这条命令设置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>eselect profile <span class=nb>set</span> <span class=s2>&#34;default/linux/amd64/17.1/desktop&#34;</span>
</code></pre></td></tr></table></div></div><p>在更新profile文件之后最好是更新一下环境，载入新的环境变量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>env-update <span class=o>&amp;&amp;</span> <span class=nb>source</span> /etc/profile <span class=o>&amp;&amp;</span> <span class=nb>export</span> <span class=nv>PS1</span><span class=o>=</span><span class=s2>&#34;(chroot) </span><span class=nv>$PS1</span><span class=s2>&#34;</span>
</code></pre></td></tr></table></div></div><p>更新系统</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose --deep --with-bdeps<span class=o>=</span>y --newuse --update @world
</code></pre></td></tr></table></div></div><p>这次切换profile文件之后再去更新出现了报错我们借助这个机会来看看如何根据Portage提供的信息来排错</p><p><img src=../../images/portage_issuse.png alt></p><p>这里Portage告诉我们当前的USE标记不能够让让Portage继续为我们更新系统，我们需要对这两个包的USE进行调整。
还记得Portage在哪里调整单个包的USE吗？没错就是在<code>/etc/portage/package.use</code>下面，这个位置可以是单个文件也可以是一个目录。
我个人比较推荐使用目录的方式去管理USE，在目录下创建单个包（原子）的文件来管理单个包的USE。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mkdir -pv /etc/portage/package.use
</code></pre></td></tr></table></div></div><blockquote><p>Python
我们按照之前说过的如何对单个包的USE进行配置，来配置python的USE</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>echo</span> <span class=s2>&#34;dev-lang/python -sqlite&#34;</span> &gt; /etc/portage/package.use/python
</code></pre></td></tr></table></div></div><blockquote><p>Sqlite</p></blockquote><p>Sqlite同样处理一下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>echo</span> <span class=s2>&#34;dev-db/sqlite -icu&#34;</span> &gt; /etc/portage/package.use/sqlite
</code></pre></td></tr></table></div></div><p>现在重新尝试更新一下系统</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose --deep --with-bdeps<span class=o>=</span>y --newuse --update @world
</code></pre></td></tr></table></div></div><p>但是这次Portage还是不给我们过并且又抛出一个错误
<img src=../../images/portage_issuse2.png alt></p><p>同样的我们按照这个提示进行修改</p><blockquote><p>Python</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>echo</span> <span class=s2>&#34;dev-lang/python -sqlite -bluetooth&#34;</span> &gt; /etc/portage/package.use/python
</code></pre></td></tr></table></div></div><blockquote><p>bluez</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>echo</span> <span class=s2>&#34;net-wireless/bluez -oboex&#34;</span> &gt; /etc/portage/package.use/bluez
</code></pre></td></tr></table></div></div><p>现在重新尝试更新一下系统</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose --deep --with-bdeps<span class=o>=</span>y --newuse --update @world
</code></pre></td></tr></table></div></div><p>现在可以正常更新了，这个更新会根据profile里面的USE设定重新构建大量的包。（可以继续工作了，让它慢慢更新好了。）</p><h3 id=安装和配置内核>安装和配置内核</h3><p>接下来就是安装和配置内核，也是最为繁琐的一个步骤。</p><p>Gentoo有很多种内核可以选择</p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>Genkernel</td><td><a href=https://wiki.gentoo.org/wiki/Genkernel>Genkernl</a>是一个用于构建内核和initramfs的构建工具，它提供了一个默认的内核配置文件。通常建议不熟悉手动编译内核的用户使用</td></tr><tr><td>gentoo-sources</td><td>对于大多数用户，建议使用的是这个内核，Gentoo会对这个内核进行维护（打一些轻量的补丁以修复安全问题，内核错误和兼容性问题）</td></tr><tr><td>gentoo-kernel</td><td>这个内核提供了默认的配置以适用于大多数不同的系统，适用于不想从头配置自己内核的用户。</td></tr><tr><td>ck-sources</td><td>这个内核是Con Kolivas的内核补丁集，这个内核主要用于提高系统响应的能力和交互性，并针对于各种工作负载进行配置。</td></tr><tr><td>git-sources</td><td>这个内核是跟踪上游开发内核的每日快照，如果你对内核的最新特性感兴趣或者是想要参与内核的开发和测试那么这个内核就是为你而生的。</td></tr></tbody></table><p>在这里我会分别介绍三种配置内核的方式</p><ol><li>Genkernel 方式配置内核</li><li>Gentoo-kernel-bin 方式配置内核</li><li>利用已有的内核配置文件配置内核</li></ol><h4 id=在配置内核之前>在配置内核之前</h4><p>在配置内核之前我们需要查看当前的硬件配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>lspci
</code></pre></td></tr></table></div></div><blockquote><p>如果没有<code>lspci</code>命令可以安装这个包</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge -av sys-apps/pciutils
</code></pre></td></tr></table></div></div><p>当然还有一种方法不让这个<code>pciutils</code>在这个<code>@world</code>集合里面我们可以自己创造一个集合
创建<code>/etc/portage/sets</code>文件夹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mkdir -pv /etc/portage/sets
</code></pre></td></tr></table></div></div><p>创建并编辑<code>/etc/portage/set/yafa</code>文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w /etc/portage/sets/yafa
</code></pre></td></tr></table></div></div><p>内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># mandatory!</span>
sys-apps/pciutils
</code></pre></td></tr></table></div></div><p>告诉Portage安装<code>@yafa</code>这个集合中的包并且自动安装其依赖</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --noreplace @yafa
</code></pre></td></tr></table></div></div><p>查看当前的硬件和使用的内核模块</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>lspci -nnk
</code></pre></td></tr></table></div></div><p><img src=../../images/lspci.png alt=lspci>
再这个图中就是我现在的这个Mac的硬件情况以及使用的内核驱动</p><h4 id=genkernel-方式配置内核>Genkernel 方式配置内核</h4><p>Genkernel 是一个自动化构建内核和<code>initramfs</code>的工具，Genkernel可以做这些事情：</p><ol><li>配置内核</li><li>构建内核(<code>bzImage</code>)并复制到<code>/boot</code></li><li>创建<code>initramfs</code>并复制到<code>/boot</code></li><li>创建 symlinks 到 <code>/boot</code></li><li>添加自定义的功能到<code>initramfs</code></li><li>压缩<code>initramfs</code></li></ol><blockquote><p>安装</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge -av sys-kernel/genkernel
</code></pre></td></tr></table></div></div><p>Genkernel用一般用法为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>genkernel --选项 动作
</code></pre></td></tr></table></div></div><blockquote><p>选项</p></blockquote><p>Genkernel选项有很多大部分可以在<code>/etc/genkernel.conf </code>这个文件中找到，在使用<code>genkernel</code>的时候命令行给定的参数优先级别是比<code>/etc/genkernel.conf</code>文件中的参数优先级高</p><blockquote><p>用户交互选项</p></blockquote><table><thead><tr><th>选项</th><th>描述</th></tr></thead><tbody><tr><td>&ndash;config=/path/to/genkernel.conf</td><td>指定配置文件。如果不实用这个选项默认使用的是<code>/etc/genkernel.conf</code>配置文件</td></tr><tr><td>&ndash;[no-]menuconfig</td><td>在开始构建内核之前，激活或者是停用（<code>make menuconfig</code>）命令 这个命令会启动交互式配置菜单</td></tr><tr><td>&ndash;gconfig</td><td>这个提供了依赖于GTK+库的内核配置程序。这个好处是用这个工具配置更加容易和清楚，不好的地方就是需要X Windows的支持没办法运行在命令行下面</td></tr><tr><td>&ndash;xconfig</td><td>和<code>--gconfig</code>选项类似，不过这个是基于QT的</td></tr><tr><td>&ndash;[no-]save-config</td><td>是否将内核配置保存到<code>/etc/kernels</code>目录下，建议开启方便以后备份和使用。</td></tr><tr><td>&ndash;kernname=NickName</td><td>允许修改<code>/boot</code>目录中的内核和<code>initramfs</code>的名称，生成的类似这种格式<code>kernel-nickname-version</code>和<code>initramfs-nickname-version</code></td></tr></tbody></table><blockquote><p>系统选项</p></blockquote><p>此处列出的配置选项定义哪些功能会或不会在生成内核和 initramfs 中启用。</p><table><thead><tr><th>选项</th><th>描述</th></tr></thead><tbody><tr><td>&ndash;[no-]splash</td><td>是否在initramfs中激活Fbsplash缓冲帧的支持。要覆盖fbsplash使用的默认主题，请使用<code>--splash=PreferredTheme</code>（其中<code>PreferredTheme</code>是<code>/etc/splash</code>目录中目录之一的标题，你可以选择其他的）。</td></tr><tr><td>&ndash;splash-res=PreferredResolution</td><td>这个选项允许系统在启动的时候准备挂载<code>/</code>阶段的分辨率。为了缩小initramfs的大小尽量选择系统支持的分辨率其他的分辨率就关掉(如果你是打算给livecd编译内核最好是省略这个选项)</td></tr><tr><td>&ndash;do-keymap-auto</td><td>在启动过程中强制选择键盘映射</td></tr><tr><td>&ndash;lvm</td><td>如果你有使用LVM逻辑卷管理请启用这个选项。（在启用之前确保系统已经安装了<code>sys-fs/lvm2</code>的包）</td></tr><tr><td>&ndash;dmraid</td><td>这个选项包含了对DMRAID的支持，如果你在使用DMRAID作为<code>/</code>文件系统请确保开启了这个选项</td></tr><tr><td>&ndash;luks</td><td>这个选项包含了对LUKS的支持，这个选项是我现在所需要的因为开启了LUKS加密，这个选项让initramfs加入了对LUKS的工具支持。</td></tr><tr><td>&ndash;disklabel</td><td>把对磁盘标签和对UUID的支持加入到initramfs</td></tr><tr><td>&ndash;iscsi</td><td>添加iscsi的支持到initramfs</td></tr><tr><td>&ndash;multipath</td><td>添加<a href=https://wiki.gentoo.org/wiki/Multipath>multipath</a>的支持到initramfs</td></tr><tr><td>&ndash;linuxrc=/path/to/the/linuxrc_file</td><td>这个选项可以指定一个用户创建的linuxrc文件（这个文件在内核启动阶段，实际引导过程之前的初始化脚本）。这个脚本可以在<code>/usr/share/genkernel/</code>下找到默认的脚本</td></tr><tr><td>&ndash;cachedir=/path/to/alt/dir</td><td>重新编译内核时候使用的默认缓存位置</td></tr><tr><td>&ndash;tempdir=/path/to/new/tempdir</td><td>指定编译内核的时候<code>genkernel</code>使用的临时目录位置</td></tr><tr><td>&ndash;unionfs</td><td>在 initramfs镜像中包含统一文件系统的支持。</td></tr><tr><td>&ndash;mountboot</td><td>是否要将<code>/boot</code>挂载到单独的分区上。这个会检查<code>/etc/fstab</code>里面的内容来获取挂载引导分区的说明（如果你需要的话）。</td></tr><tr><td>&ndash;microcode</td><td>为Xen和Linux早期微码支持创建一个Intel/Amd处理器微码的早期cpio</td></tr></tbody></table><blockquote><p>构建选项</p></blockquote><p>Genkernel 支持下面这些选项，并且在构建内核的时候将其传给相关的应用程序。</p><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>&ndash;kernel-cc=someCompiler</td><td>指定内核在编译时候使用的编译器</td></tr><tr><td>&ndash;kernel-ld=someLinker</td><td>指定内核编译过程中使用的链接器</td></tr><tr><td>&ndash;kernel-as=someAssembler</td><td>指定内核编译过程中使用的汇编程序</td></tr><tr><td>&ndash;kernel-make=someMake</td><td>指定内核编译过程中使用的Make程序的替代方法</td></tr><tr><td>&ndash;utils-cc=someCompiler</td><td>指定在编译实用工具过程中使用的编译器</td></tr><tr><td>&ndash;utils-ld=someLinker</td><td>指定在编译实用工具过程中使用的链接器</td></tr><tr><td>&ndash;utils-as=someAssembler</td><td>指定在编译实用工具过程中使用的汇编程序</td></tr><tr><td>&ndash;utils-make=someMake</td><td>指定在编译实用工具过程中使用的Make程序的替代方法</td></tr><tr><td>&ndash;makeopts=-jX</td><td>指定编译内核和实用工具时候的并发线程数。（通常是线程数+1）</td></tr></tbody></table><blockquote><p>在编译过程中起作用的选项</p></blockquote><p>下面这些选项通常在编译过程中生效：</p><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>&ndash;kerneldir=/path/to/sources/</td><td>指定内核源码的位置，可以不是默认的<code>/usr/src/linux</code>目录</td></tr><tr><td>&ndash;kernel-config=/path/to/config-file</td><td>指定内核使用的配置文件。默认情况下会在 <code>--kerneldir</code>中找到的内核版本，并在<code>/etc/kernel/</code>下面找到对应的内核版本。如果没有找到<code>genkernel</code>将会在<code>/usr/share/genkernel/$arch/</code>下面找通用的内核配置。</td></tr><tr><td>&ndash;module-prefix=/path/to/prefix-directory/</td><td>指定要安装内核模块的目录。（默认是/lib/modules）</td></tr><tr><td>&ndash;[no-]clean</td><td>在编译内核之前执行或者是不执行<code>make clean</code>命令。</td></tr><tr><td>&ndash;[no-]mrproper</td><td>在内核编译之前启用或停用<code>make mrproper</code>命令。像是之前的<code>make clean</code>命令类似的这个命令会删除所有目标文件和依赖项但是除了这些还会删除旧的配置文件。如果你不想要删除你的旧内核配置文件请保持这个选项关闭</td></tr><tr><td>&ndash;oldconfig</td><td>发出<code>make oldconfig</code>命令，这个命令将会尝试从<code>/usr/share/genkernel/</code>中的通用脚本收集系统的信息。这是一个非交互的过程：没有用户输出。（如果和<code>--clean</code>结合使用后面的<code>--clean</code>将会失效）</td></tr><tr><td>&ndash;[no-]module-rebuild</td><td>在构建内核和内核模块之后，运行或者是不运行<code>emerge @module-rebuild</code>来构建额外的模块(比如说virtualbox的模块)。默认的情况下启用这个选项</td></tr><tr><td>&ndash;callback=&ldquo;echo hello&rdquo;</td><td>在构建内核和内核模块之后，但是在构建initramfs之前，调用指定的参数在这个例子里面为 <code>hello</code></td></tr><tr><td>&ndash;[no-]install</td><td>激活或者是取消<code>make install</code>命令，这个命令将会把内核文件和initrafms文件copy到引导分区。</td></tr><tr><td>&ndash;no-ramdisk-modules</td><td>避免将任何模块复制到<code>genkernel</code>创建的<code>initramfs</code>中。</td></tr><tr><td>&ndash;all-ramdisk-modules</td><td>将所有可用的模块全部复制到<code>genkernel</code>创建的<code>initramfs</code>中。</td></tr><tr><td>&ndash;genzimage</td><td>在创建内核之前先创建initramfs（这个只适用于PPC）</td></tr></tbody></table><blockquote><p>debug 参数</p></blockquote><p>在内核编译过程中可以通过调整debug参数来控制输出的信息和显示方式。</p><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td><code>--loglevel=&lt;0|1|2|3|4|5></code></td><td>控制genkernel打印信息的详细程度。变量<code>loglevel</code>是0-5之间的整数。0代表无输出5代表在内核编译和制作initramfs过程中尽可能提供更多的信息</td></tr><tr><td>&ndash;logfile=/path/to/output_file</td><td>Genkernel默认的输出的日志文件。默认的输出在<code>/var/log/genkernel.log</code></td></tr><tr><td>&ndash;[no-]color</td><td>激活或者是取消带颜色输出</td></tr><tr><td>&ndash;[no-]cleanup</td><td>激活或取消运行后的清理，从而达到调试的目的</td></tr></tbody></table><blockquote><p>动作</p></blockquote><p>Genkernel 支持以下操作：</p><table><thead><tr><th>动作</th><th>描述</th></tr></thead><tbody><tr><td>all</td><td>构建所有的东西，包括<code>initramfs</code>、<code>kernel</code>、<code>modules</code></td></tr><tr><td>bzImage</td><td>只构建内核的镜像</td></tr><tr><td>kernel</td><td>只构建内核镜像和模块</td></tr><tr><td>initramfs</td><td>只构建<code>initramfs</code></td></tr></tbody></table><blockquote><p>配置</p></blockquote><p>Genkernel 给用户提供了一个最简单的方法那就是<code>genkernel all</code>但是会生成大量不必要的模块，这里有一个适用于大多数系统的通用配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>genkernel --luks --no-install --no-clean --menuconfig all
</code></pre></td></tr></table></div></div><p>上面这条命令就是创建了一个可以支持LUKS的initramfs，但是内核和initramfs都不会被安装到引导分区后面的<code>--menuconfig</code>将会打开交互式配置工具，从而进行交互式配置。
<img src=../../images/menuconfig.png alt>
在交互界面如果你是老手你可以开始配置你的内核，如果你是新手这次我们先选择退出按esc会提示是否保存配置文件，我们选择保存，就会开始构建新的内核以及<code>initramfs</code>。</p><p>等到构建完成之后可以看<code>/var/tmp/genkernel/</code>下面这里面就是我们构建的内核以<code>initramfs</code>文件了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>ls /var/tmp/genkernel/
System.map-x86_64-5.4.80-gentoo-r1-x86_64  initramfs-x86_64-5.4.80-gentoo-r1-x86_64  kernel-x86_64-5.4.80-gentoo-r1-x86_64
</code></pre></td></tr></table></div></div><p>除了这种交互式的配置还可以通过修改配置文件来减少刚开始配置内核的工作量，还记得<code>genkernel</code>的默认配置文件位置吗？我们将会复制一份在此基础上进行修改来生成我们的第一份内核配置文件。</p><p>首先创建我们的工作目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mkdir -pv /tmp/workdir
<span class=nb>cd</span> /tmp/workdir
</code></pre></td></tr></table></div></div><p>复制一份默认的配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>cp -v /etc/genkernel.conf .
</code></pre></td></tr></table></div></div><p>修改配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w genkernel.conf
</code></pre></td></tr></table></div></div><p>内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nv>INSTALL</span><span class=o>=</span><span class=s2>&#34;no&#34;</span>
<span class=nv>OLDCONFIG</span><span class=o>=</span><span class=s2>&#34;yes&#34;</span>
<span class=nv>MENUCONFIG</span><span class=o>=</span><span class=s2>&#34;yes&#34;</span>
<span class=nv>MRPROPER</span><span class=o>=</span><span class=s2>&#34;no&#34;</span>
<span class=nv>CLEAN</span><span class=o>=</span><span class=s2>&#34;yes&#34;</span>
<span class=nv>SAVE_CONFIG</span><span class=o>=</span><span class=s2>&#34;yes&#34;</span>
<span class=nv>NOCOLOR</span><span class=o>=</span><span class=s2>&#34;false&#34;</span>
<span class=nv>LUKS</span><span class=o>=</span><span class=s2>&#34;yes&#34;</span>
<span class=nv>MICROCODE</span><span class=o>=</span><span class=s2>&#34;intel&#34;</span>
<span class=nv>MICROCODE_INITRAMFS</span><span class=o>=</span><span class=s2>&#34;yes&#34;</span>
<span class=nv>BUSYBOX</span><span class=o>=</span><span class=s2>&#34;yes&#34;</span>
<span class=nv>E2FSPROGS</span><span class=o>=</span><span class=s2>&#34;yes&#34;</span>
<span class=nv>GK_SHARE</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GK_SHARE</span><span class=k>:-</span><span class=p>/usr/share/genkernel</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=nv>CACHE_DIR</span><span class=o>=</span><span class=s2>&#34;/var/cache/genkernel&#34;</span>
<span class=nv>DISTDIR</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>GK_SHARE</span><span class=si>}</span><span class=s2>/distfiles&#34;</span>
<span class=nv>LOGFILE</span><span class=o>=</span><span class=s2>&#34;/var/log/genkernel.log&#34;</span>
<span class=nv>LOGLEVEL</span><span class=o>=</span><span class=m>1</span>
<span class=nv>DEFAULT_KERNEL_SOURCE</span><span class=o>=</span><span class=s2>&#34;/usr/src/linux&#34;</span>
</code></pre></td></tr></table></div></div><p>再次生成内核文件和<code>initramfs</code>文件:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>genkernel --config<span class=o>=</span>genkernel.conf all
</code></pre></td></tr></table></div></div><p>到这里你就有了一份基本的内核配置并且已经可以启动了（大概率），但是网卡之类的可能还是不能正常工作。这个时候就需要针对于自己的硬件去查找对于的配置了。
这里我推荐你查看<a href=www.jinbuguo.com/kernel/longterm-linux-kernel-options.html>金步国配置内核选项介绍</a>这篇文档，来去配置你的内核，当然内核配置和我们现在安装的选项有很大的不同了，还需要再去搜索内核文档这些选项的意义。
如果你有充足的时间我建议你可以尝试使用<code>make config</code>然后使用Google搜索。</p><h4 id=使用gentoo-kernel-bin配置内核>使用<code>gentoo-kernel-bin</code>配置内核</h4><p><code>gentoo-kernel-bin</code>就是上游打好的内核如果想要快速进入系统，后面再去慢慢配置内核这个内核也是一个不错的选项。</p><blockquote><p>安装</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge -av sys-kernel/gentoo-kernel-bin
</code></pre></td></tr></table></div></div><p>安装完成之后内核以及<code>initramfs</code>已经在<code>/boot</code>下面了。</p><h4 id=使用已有的配置文件配置内核>使用已有的配置文件配置内核</h4><p>我这里有一份配置好的内核配置，功能上已经调好了，内核使用的是<code>gentoo-sources</code>内核</p><p>在安装内核之前我们要先设置一下<code>gentoo-sources</code>的USE</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>echo</span> <span class=s2>&#34;sys-kernel/gentoo-sources experimental symlink&#34;</span> &gt; /etc/portage/package.use/gentoo-sources
</code></pre></td></tr></table></div></div><p><code>symlink</code>可以当更新内核的时候自动将最新的内核软连接到<code>/usr/src/linux</code>目录。
<code>experimental</code> 这个可以针对CPU来进行优化，和一些实验性特性，详细可以参考<a href=https://wiki.gentoo.org/wiki/Project:Kernel/Experimental>这里</a>
现在我们可以安装内核了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose gentoo-sources
</code></pre></td></tr></table></div></div><p>首先进入内核文件夹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>cd</span> /usr/src/linux
</code></pre></td></tr></table></div></div><p>下载我的内核配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>wget -O .config  https://raw.githubusercontent.com/yafa-xena/dotfiles/main/etc/kernels/config-5.4.80-gentoo-r1-x86_64
</code></pre></td></tr></table></div></div><p>使用<code>make oldconfig</code>去生成一份新的配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>make oldconfig
</code></pre></td></tr></table></div></div><p>也许你需要在我这个内核基础上再去做一些修改</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>make menuconfig
</code></pre></td></tr></table></div></div><p>修改工作完成之后可以运行以下命令生成新的内核和模块并将其安装到<code>/boot</code>目录下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>make -j9
make modules_install
make install
</code></pre></td></tr></table></div></div><h3 id=生成initramfs>生成initramfs</h3><p>initramfs其实是<code>initrd</code>的替代品，它是一个临时的文件系统，它在启动阶段被<code>linux</code>内核调用。<code>initrd</code>主要当作<code>/</code>文件系统被挂载之前做准备工作。
如果你将必要的驱动都build in内核是可以不要initramfs的，这里我使用的LUKS全盘加密，需要initramfs阶段来解开LUKS分区。</p><p>生成initramfs的方式也有很多，这里我会介绍以下2种方式生成initramfs：</p><ol><li>genkernel</li><li>Dracut</li></ol><blockquote><p>genkernel</p></blockquote><p>在之前genkernel安装的内核的时候已经介绍的非常详细了如果你想要单独生成一个initramfs可以使用这条命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>genkernel --luks initramfs
</code></pre></td></tr></table></div></div><p><code>--luks</code>这个参数是因为我这次安装是用到了luks所以要在<code>initramfs</code>中加入LUKS的工具支持。</p><p>除此之外还要安装<code>sys-fs/cryptsetup</code>这个包，不然重启之后由于缺少这个工具还是没办法正常使用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge -av sys-fs/cryptsetup
</code></pre></td></tr></table></div></div><blockquote><p>Dracut</p></blockquote><p>安装</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge -av  sys-kernel/dracut
</code></pre></td></tr></table></div></div><p>构建initramfs
首先确保你的<code>/boot</code>分区已经挂载了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>dracut
</code></pre></td></tr></table></div></div><p>这样不加任何参数将会创建一个通用的<code>initrmafs</code>
如果你想要只为这个机器创建<code>initrmafs</code>可以加<code>--hostonly</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>dracut --hostonly
</code></pre></td></tr></table></div></div><p>dracut还有很多额外的模块，像是这次安装我们就需要用到<code>crypt</code>模块，还有很多模块如下表：</p><table><thead><tr><th>模块名称</th><th>描述</th><th>Enable?</th><th>额外包</th></tr></thead><tbody><tr><td>dash</td><td>包含了<code>/bin/dash</code>和<code>/bin/sh</code></td><td>always</td><td></td></tr><tr><td>i18n</td><td>包含了键盘布局，console的字体等等</td><td>always</td><td></td></tr><tr><td>rpmversion</td><td>在<code>initramfs</code>中包含dracut的版本信息</td><td>当<code>/etc/redhat-release </code>存在的时候这个模块会被打开</td><td></td></tr><tr><td>convertfs</td><td>在下一次启动中将 <code>/</code> 合并到 <code>/usr</code> 中</td><td>never</td><td></td></tr><tr><td>kernel-modules</td><td>包含用于<code>/</code>文件系统和其他设备启动时设备的内核模块</td><td>always</td><td></td></tr><tr><td>fstab-sys</td><td>安排在<code>rootfs</code>之前挂载任意分区</td><td>当<code>/etc/fstab.sys</code>存在的时候，或者是命令行包含<code>--fstab</code> 或者是<code>--add_fstab</code>时。</td><td></td></tr><tr><td>resume</td><td>允许<code>initramfs</code> 从低功耗模式状态恢复。</td><td>当存在swap分区的时候</td><td></td></tr><tr><td>rootfs-block</td><td>安排包含要挂载<code>rootfs</code>的块设备。</td><td>always</td><td></td></tr><tr><td>terminfo</td><td>包含<code>terminfo</code>文件</td><td>always</td><td></td></tr><tr><td>udev-rules</td><td>包含一些非常基本的udev规则</td><td>always</td><td></td></tr><tr><td>securityfs</td><td>安排尽早挂载<code>securityfs</code></td><td>never</td><td></td></tr><tr><td>usrmount</td><td>安排挂载 <code>/usr</code></td><td>always</td><td></td></tr><tr><td>base</td><td>包含大部分基本的工具</td><td>always</td><td></td></tr><tr><td>fs-lib</td><td>包含了文件系统工具（包括<code>mount</code>命令）</td><td>always</td><td></td></tr><tr><td>img-lib</td><td>包含了用于解压图像的工具</td><td>never</td><td></td></tr><tr><td>shutdown</td><td>设置用于关机的<code>hook</code></td><td>always</td><td></td></tr><tr><td>biosdevname</td><td>开启BIOS网络设备的重命名</td><td>always</td><td>需要安装<code>sys-apps/pciutils</code>和<code>sys-apps/biosdevname</code>包</td></tr><tr><td>btrfs</td><td>btrfs文件系统的支持</td><td>host-only: rootfs</td><td><code>sys-fs/btrfs-progs</code></td></tr><tr><td>caps</td><td>支持在初始化之前删除功能</td><td>systemd init 不使用</td><td><code>sys-libs/libcap</code></td></tr><tr><td>crypt</td><td>支持全盘加密<code>rootfs</code></td><td>host-only: rootfs</td><td><code>sys-fs/cryptsetup</code>这里我们使用了LUKS加密所以还要安装这个包</td></tr><tr><td>crypt-gpg</td><td>将GPG用于crypt支持（需要crypt模块）</td><td>never</td><td><code>app-crypt/gnupg</code></td></tr><tr><td>dmraid</td><td>支持<code>rootfs</code>在FakeRAID上</td><td>host-only: rootfs</td><td><code>sys-fs/multipath-tools</code>, <code>sys-fs/dmraid</code></td></tr><tr><td>dmsquash-live</td><td>支持LiveCD的<code>rootfs</code></td><td>never (host-only: refused)</td><td></td></tr><tr><td>gensplash</td><td>包含一个静态启动画面</td><td>never</td><td><code>media-gfx/splashutils</code>在官网的portage树已经找不到了</td></tr><tr><td>iscsi</td><td><code>rootfs</code>在iscsi设备上的支持</td><td>host-only: rootfs</td><td><code>sys-block/open-iscsi</code></td></tr><tr><td>livenet</td><td>通过HTTP检索<code>rootfs</code>需要<code>dmsquash-live</code>模块</td><td>never</td><td></td></tr><tr><td>lvm</td><td>支持<code>rootfs</code>在LVM逻辑卷管理上</td><td>host-only: rootfs</td><td><code>sys-fs/lvm2</code></td></tr><tr><td>mdraid</td><td>支持<code>rootfs</code>在软RAID上</td><td>host-only: rootfs</td><td><code>sys-fs/mdadm</code></td></tr><tr><td>multipath</td><td>支持<code>rootfs</code>在多路径上</td><td>host-only: rootfs</td><td><code>sys-fs/multipath-tools</code></td></tr><tr><td>nbd</td><td>支持<code>rootfs</code>在网络块设备上</td><td>host-only: rootfs</td><td><code>sys-block/nbd</code></td></tr><tr><td>nfs</td><td>支持NFS挂载<code>rootfs</code></td><td>host-only: rootfs</td><td><code>net-fs/nfs-utils</code>和<code>net-nds/rpcbind</code></td></tr><tr><td>plymouth</td><td>包含启动动画</td><td>always</td><td><code>sys-boot/plymouth</code></td></tr><tr><td>ssh-client</td><td>包含ssh和scp客户端</td><td>never</td><td><code>dev-libs/openssl</code></td></tr><tr><td>syslog</td><td>包含远程登陆日志</td><td>never</td><td><code>app-admin/syslog-ng</code>或者是<code>rsyslog</code></td></tr><tr><td>debug</td><td>包含常用的故障排除工具</td><td>never</td><td>安装Dracut时候开启 <code>USE=debug</code></td></tr><tr><td>dm</td><td>包含 device-mapper</td><td>never</td><td><code>sys-fs/device-mapper</code> 或者是 <code>sys-fs/lvm2</code></td></tr><tr><td>ifcfg</td><td>在运行时候生成网络配置</td><td>never</td><td></td></tr><tr><td>network</td><td>为网络启动启用网络</td><td>always</td><td><code>net-misc/dhcp</code>和 <code>sys-apps/iproute2</code></td></tr><tr><td>selinux</td><td>安排要加载的Selinux策略</td><td>当安装开启 <code>USE=selinux</code>的时候</td><td></td></tr><tr><td>url-lib</td><td>包含curl命令和SSL证书</td><td>never</td><td><code>net-misc/curl</code></td></tr></tbody></table><blockquote><p>设定配置文件
主配置文件默认在<code>/etc/dracut.conf</code></p></blockquote><p>我这里创建一个全新的文件来做dracut的配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w /etc/dracut.conf.d/yafa.conf
</code></pre></td></tr></table></div></div><p>内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nv>hostonly</span><span class=o>=</span><span class=s2>&#34;yes&#34;</span>
<span class=nv>compress</span><span class=o>=</span><span class=s2>&#34;xz&#34;</span>
<span class=nv>add_drivers</span><span class=o>+=</span><span class=s2>&#34; i915 &#34;</span>
<span class=nv>omit_dracutmodules</span><span class=o>+=</span><span class=s2>&#34; resume crypt base dash &#34;</span>
</code></pre></td></tr></table></div></div><p>保存并退出</p><p>生成<code>initramfs</code>文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>dracut --kver 5.4.80-gentoo-r1-x86_64 /boot/initramfs.img
</code></pre></td></tr></table></div></div><h3 id=安装bootload>安装bootload</h3><p>这里使用的bootload是GRUB</p><p>安装</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose sys-boot/grub
</code></pre></td></tr></table></div></div><p>安装grub到引导分区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>grub-install --target<span class=o>=</span>x86_64-efi --efi-directory<span class=o>=</span>/boot --bootloader-id<span class=o>=</span>Gentoo
</code></pre></td></tr></table></div></div><p>因为我们使用LUKS还需要对grub进行配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w /etc/default/grub
</code></pre></td></tr></table></div></div><p>按Ctrl+w 进入查找模式输入
<code>GRUB_CMDLINE_LINUX</code>回车，去掉掉这行的注释（删除<code>#</code>号）
修改内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nv>GRUB_CMDLINE_LINUX</span><span class=o>=</span><span class=s2>&#34;crypt_root=UUID=dbdff0d5-0c06-44b8-9879-a56400c80135  root=/dev/mapper/root root_trim=yes rhgb  alpha_support=1 loglevel=7&#34;</span>
</code></pre></td></tr></table></div></div><p>分别来说一下添加这些内容的含义</p><p><code>crypt_root=UUID=dbdff0d5-0c06-44b8-9879-a56400c80135</code> 这个是LUKS分区的UUID可以用过<code>lsblk</code>查看：例如</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>/dev/nvme0n1p1: <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;46CB-9AA9&#34;</span> <span class=nv>BLOCK_SIZE</span><span class=o>=</span><span class=s2>&#34;512&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;vfat&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;72c3ee7b-0dd2-0a40-905b-aac98ac8595c&#34;</span>
/dev/nvme0n1p2: <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;dbdff0d5-0c06-44b8-9879-a56400c80135&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;crypto_LUKS&#34;</span> <span class=nv>PTTYPE</span><span class=o>=</span><span class=s2>&#34;atari&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;5204fbd0-506e-9544-9c6f-a97c6eb3db9b&#34;</span>
/dev/sdb1: <span class=nv>BLOCK_SIZE</span><span class=o>=</span><span class=s2>&#34;2048&#34;</span> <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;2020-10-22-14-30-30-00&#34;</span> <span class=nv>LABEL</span><span class=o>=</span><span class=s2>&#34;Ubuntu 20.10 amd64&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;iso9660&#34;</span> <span class=nv>PARTLABEL</span><span class=o>=</span><span class=s2>&#34;ISO9660&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;7ee1ffac-4072-46b8-885f-a7ea3f9c70cf&#34;</span>
/dev/sdb2: <span class=nv>SEC_TYPE</span><span class=o>=</span><span class=s2>&#34;msdos&#34;</span> <span class=nv>LABEL_FATBOOT</span><span class=o>=</span><span class=s2>&#34;ESP&#34;</span> <span class=nv>LABEL</span><span class=o>=</span><span class=s2>&#34;ESP&#34;</span> <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;F366-AE33&#34;</span> <span class=nv>BLOCK_SIZE</span><span class=o>=</span><span class=s2>&#34;512&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;vfat&#34;</span> <span class=nv>PARTLABEL</span><span class=o>=</span><span class=s2>&#34;Appended2&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;7ee1ffac-4072-46b8-885c-a7ea3f9c70cf&#34;</span>
/dev/sdb4: <span class=nv>LABEL</span><span class=o>=</span><span class=s2>&#34;writable&#34;</span> <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;7de65921-149d-4ed6-bb21-aa48ed19953a&#34;</span> <span class=nv>BLOCK_SIZE</span><span class=o>=</span><span class=s2>&#34;4096&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;ext4&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;c34a7c6d-268d-5b40-91f1-e4e268a26a40&#34;</span>
/dev/mapper/system: <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;7e664075-eedd-4d1a-9218-ac4c6471b033&#34;</span> <span class=nv>BLOCK_SIZE</span><span class=o>=</span><span class=s2>&#34;4096&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;ext4&#34;</span>
/dev/sdb3: <span class=nv>PARTLABEL</span><span class=o>=</span><span class=s2>&#34;Gap1&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;7ee1ffac-4072-46b8-885d-a7ea3f9c70cf&#34;</span>
</code></pre></td></tr></table></div></div><p>这里的话<code>/dev/nvme0n1p2</code>就是LUKS分区所在的UUID不要复制错了</p><p><code>root=/dev/mapper/root</code> 这个是解开LUKS分区后的默认位置
<code>root_trim=yes</code> 开启ssd的trim功能
<code>rhgb</code> 详细模式像是硬件检测之类的信息都会打印出来如果你不想要这些你可以设置为<code>quite</code>
<code>alpha_support=1</code> 测试的支持
<code>loglevel=7</code> 内核debug模式 如果你不想要详细的输出可以尝试调成其他的数值<code>0-7</code></p><p>保存退出</p><p>生成<code>grub.cfg</code>文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>grub-mkconfig -o /boot/grub/grub.cfg
</code></pre></td></tr></table></div></div><h3 id=配置fstab>配置fstab</h3><p>配置fstab可以选择手写的方式也可以选择使用Archlinux的genfstab来生成fstab文件，个人比较推荐用Archlinx的genfstab来去做，减少人工输入的错误。</p><blockquote><p>手写的方式配置fstab</p></blockquote><p>基本语法
<code>/etc/fstab</code>这个文件中每行都包含一个分区，驱动器或者是网络共享必须要设置。每行有6列，由空格和制表符分割。列内容如下：</p><ol><li>设备文件，UUID或者是标签或者是其他找到分区或数据源的方法</li><li>将分区或者是数据源挂载到的目录</li><li>文件系统类型</li><li>选项，包括是否在引导阶段挂载系统</li><li>调整分区的存档计划(<code>app-arch/dump</code>使用)。0为禁用，1为启用该功能。</li><li>控制fsck在引导时检查设备/分区是否有错误，根分区应该是1。 其他的分区应该是2 （用于在root之后检查）用0就是完全不检查。
e.g.</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>&lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
</code></pre></td></tr></table></div></div><p>让我们一起写一个很简单的挂载<code>/</code>分区的例子，首先查看一下当前分区的UUID</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>blkid
/dev/nvme0n1p1: <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;46CB-9AA9&#34;</span> <span class=nv>BLOCK_SIZE</span><span class=o>=</span><span class=s2>&#34;512&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;vfat&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;72c3ee7b-0dd2-0a40-905b-aac98ac8595c&#34;</span>
/dev/nvme0n1p2: <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;dbdff0d5-0c06-44b8-9879-a56400c80135&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;crypto_LUKS&#34;</span> <span class=nv>PTTYPE</span><span class=o>=</span><span class=s2>&#34;atari&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;5204fbd0-506e-9544-9c6f-a97c6eb3db9b&#34;</span>
/dev/sdb1: <span class=nv>BLOCK_SIZE</span><span class=o>=</span><span class=s2>&#34;2048&#34;</span> <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;2020-10-22-14-30-30-00&#34;</span> <span class=nv>LABEL</span><span class=o>=</span><span class=s2>&#34;Ubuntu 20.10 amd64&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;iso9660&#34;</span> <span class=nv>PARTLABEL</span><span class=o>=</span><span class=s2>&#34;ISO9660&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;7ee1ffac-4072-46b8-885f-a7ea3f9c70cf&#34;</span>
/dev/sdb2: <span class=nv>SEC_TYPE</span><span class=o>=</span><span class=s2>&#34;msdos&#34;</span> <span class=nv>LABEL_FATBOOT</span><span class=o>=</span><span class=s2>&#34;ESP&#34;</span> <span class=nv>LABEL</span><span class=o>=</span><span class=s2>&#34;ESP&#34;</span> <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;F366-AE33&#34;</span> <span class=nv>BLOCK_SIZE</span><span class=o>=</span><span class=s2>&#34;512&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;vfat&#34;</span> <span class=nv>PARTLABEL</span><span class=o>=</span><span class=s2>&#34;Appended2&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;7ee1ffac-4072-46b8-885c-a7ea3f9c70cf&#34;</span>
/dev/sdb4: <span class=nv>LABEL</span><span class=o>=</span><span class=s2>&#34;writable&#34;</span> <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;7de65921-149d-4ed6-bb21-aa48ed19953a&#34;</span> <span class=nv>BLOCK_SIZE</span><span class=o>=</span><span class=s2>&#34;4096&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;ext4&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;c34a7c6d-268d-5b40-91f1-e4e268a26a40&#34;</span>
/dev/mapper/system: <span class=nv>UUID</span><span class=o>=</span><span class=s2>&#34;7e664075-eedd-4d1a-9218-ac4c6471b033&#34;</span> <span class=nv>BLOCK_SIZE</span><span class=o>=</span><span class=s2>&#34;4096&#34;</span> <span class=nv>TYPE</span><span class=o>=</span><span class=s2>&#34;ext4&#34;</span>
/dev/sdb3: <span class=nv>PARTLABEL</span><span class=o>=</span><span class=s2>&#34;Gap1&#34;</span> <span class=nv>PARTUUID</span><span class=o>=</span><span class=s2>&#34;7ee1ffac-4072-46b8-885d-a7ea3f9c70cf&#34;</span>
</code></pre></td></tr></table></div></div><p>以及挂载点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sdb           8:16   <span class=m>1</span>  57.8G  <span class=m>0</span> disk
<span class=p>|</span>-sdb1        8:17   <span class=m>1</span>   2.8G  <span class=m>0</span> part
<span class=p>|</span>-sdb2        8:18   <span class=m>1</span>   4.9M  <span class=m>0</span> part
<span class=p>|</span>-sdb3        8:19   <span class=m>1</span>   300K  <span class=m>0</span> part
<span class=sb>`</span>-sdb4        8:20   <span class=m>1</span>  55.1G  <span class=m>0</span> part
nvme0n1     259:0    <span class=m>0</span>   1.9T  <span class=m>0</span> disk
<span class=p>|</span>-nvme0n1p1 259:1    <span class=m>0</span>    64M  <span class=m>0</span> part  /boot
<span class=sb>`</span>-nvme0n1p2 259:2    <span class=m>0</span>   1.9T  <span class=m>0</span> part
  <span class=sb>`</span>-system  253:0    <span class=m>0</span>   1.9T  <span class=m>0</span> crypt /
</code></pre></td></tr></table></div></div><p>我们可以看到这个<code>/dev/mapper/system</code>这个分区是挂载在<code>/</code>下面的其分区UUID为<code>7e664075-eedd-4d1a-9218-ac4c6471b033</code>那么我们可以这样写<code>fstab</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>/dev/mapper/system      /               ext4            defaults    <span class=m>0</span> <span class=m>1</span>
</code></pre></td></tr></table></div></div><p>也许你注意到了这里有个 <code>defaults</code>参数这个是干嘛的？这个是给使用的文件系统传输挂载的选项，许多都是通用的但是有些选项是特定文件系统才有的，这个说起来有点复杂请看下面这个表格：</p><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>defaults</td><td>使用默认挂载选项 <code>rw,suid,dev,exec,auto,nouser,async</code></td></tr><tr><td>auto</td><td>在启动的时候自动挂载文件系统</td></tr><tr><td>noauto</td><td>不在启动的时候自动挂载文件系统（这个通常为了安全可以这样设置，比如说boot下面存LUKS的KEY）</td></tr><tr><td>ro</td><td>以只读的方式挂载文件系统</td></tr><tr><td>rw</td><td>读写的方式挂载文件系统</td></tr><tr><td>sw</td><td>挂载swap文件系统</td></tr><tr><td>atime</td><td>每次读取的时候更新inode的访问时间</td></tr><tr><td>relatime</td><td>仅在写入时更新inode的访问时间以提高性能</td></tr><tr><td>noatime</td><td>从不更新inode的访问时间来获得最高性能</td></tr><tr><td>sync</td><td>在每次写入之后同步到设备。这个可能会缩短SSD的寿命</td></tr><tr><td>async</td><td>异步同步驱动器</td></tr><tr><td>discard</td><td>等于开启了trim的支持</td></tr><tr><td>exec</td><td>允许执行二进制文件</td></tr><tr><td>noexec</td><td>不允许执行二进制文件</td></tr><tr><td>suid</td><td>跟随<code>SUID</code>和<code>SGID</code>位。</td></tr><tr><td>nosuid</td><td>不跟随<code>SUID</code>和<code>SGID</code>位</td></tr><tr><td>user</td><td>允许用户挂载文件系统</td></tr><tr><td>users</td><td>允许每个用户挂载文件系统</td></tr><tr><td>nouser</td><td>只允许root用户挂载文件系统</td></tr></tbody></table><p>这些选项可以根据你的需要来灵活调整。</p><blockquote><p>genfstab方式配置fstab</p></blockquote><p>可以从我的<code>dotfiles</code>里面找到这个<code>genfstab</code>脚本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>wget -c O /usr/bin/genfstab https://raw.githubusercontent.com/yafa-xena/dotfiles/main/usr/bin/genfstab
chmod +x /usr/bin/genfstab
</code></pre></td></tr></table></div></div><p>生成<code>fstab</code>格式的输出</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>genfstab -U / 
<span class=c1># /dev/mapper/system</span>
/dev/mapper/system      /               ext4            rw,relatime     <span class=m>0</span> <span class=m>1</span>

<span class=c1># /dev/nvme0n1p1</span>
/dev/nvme0n1p1          /boot           vfat            rw,relatime,fmask<span class=o>=</span>0022,dmask<span class=o>=</span>0022,codepage<span class=o>=</span>437,iocharset<span class=o>=</span>iso8859-1,shortname<span class=o>=</span>mixed,errors<span class=o>=</span>remount-ro <span class=m>0</span> <span class=m>2</span>

<span class=c1># cgroup2</span>
cgroup2                 /sys/fs/cgroup/unified  cgroup2         rw,nosuid,nodev,noexec,relatime,nsdelegate      <span class=m>0</span> <span class=m>0</span>

<span class=c1># efivarfs</span>
efivarfs                /sys/firmware/efi/efivars       efivarfs        rw,nosuid,nodev,noexec,relatime <span class=m>0</span> <span class=m>0</span>

<span class=c1># none</span>
none                    /sys/fs/bpf     bpf             rw,nosuid,nodev,noexec,relatime,mode<span class=o>=</span><span class=m>700</span>        <span class=m>0</span> <span class=m>0</span>

<span class=c1># tracefs</span>
tracefs                 /sys/kernel/debug/tracing       tracefs         rw,nosuid,nodev,noexec,relatime <span class=m>0</span> <span class=m>0</span>

<span class=c1># tracefs</span>
tracefs                 /sys/kernel/tracing     tracefs         rw,nosuid,nodev,noexec,relatime <span class=m>0</span> <span class=m>0</span>

</code></pre></td></tr></table></div></div><p>将输出追加到<code>/etc/fstab</code>文件中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>genfstab -U / &gt;&gt; /etc/fstab
</code></pre></td></tr></table></div></div><p>这里有很多不需要的可以删除掉类似<code>tracefs</code>、<code>cgroup2</code>、<code>none</code>等等，精简后的<code>fstab</code>文件如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># /dev/mapper/system</span>
/dev/mapper/system      /               ext4            rw,relatime     <span class=m>0</span> <span class=m>1</span>

<span class=c1># /dev/nvme0n1p1</span>
/dev/nvme0n1p1          /boot           vfat            rw,relatime,fmask<span class=o>=</span>0022,dmask<span class=o>=</span>0022,codepage<span class=o>=</span>437,iocharset<span class=o>=</span>iso8859-1,shortname<span class=o>=</span>mixed,errors<span class=o>=</span>remount-ro <span class=m>0</span> <span class=m>2</span>
</code></pre></td></tr></table></div></div><p>到这里<code>fstab</code>的配置就算是完成了。</p><h3 id=安装网络组件>安装网络组件</h3><p>为了重启之后机器还能够正常上网和排障，所以这里还需要安装一个网络组建，我这里更倾向于NetwrokManager这个网络组建，当然你也可以选择其他的网络组件</p><p>安装</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge -av networkmanager
</code></pre></td></tr></table></div></div><p>启动</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>rc-update add NetworkManager default
</code></pre></td></tr></table></div></div><h3 id=设置主机名>设置主机名</h3><p>编辑<code>/etc/conf.d/hostname</code>
修改内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=c1># Set to the hostname of this machine</span>
<span class=nv>hostname</span><span class=o>=</span><span class=s2>&#34;yafa&#34;</span>
</code></pre></td></tr></table></div></div><p>你可以将<code>yafa</code>设置成你喜欢的名字</p><h3 id=添加和设置管理员账户>添加和设置管理员账户</h3><p>现在我们可以给root用户设置密码了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>passwd root
</code></pre></td></tr></table></div></div><blockquote><p>注意输入密码是没有回显的</p></blockquote><p>但是日常用root操作还是太过于危险了，我们需要创建一个管理员用户作为我们日常的使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>useradd -m -G users,wheel,portage,usb,video,tty xena 
</code></pre></td></tr></table></div></div><blockquote><p>xena 是我的用户名你可以换成你的</p></blockquote><p>设置密码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>passwd xena
</code></pre></td></tr></table></div></div><blockquote><p>注意输入密码是没有回显的</p></blockquote><p>为了实现临时的超级管理员权限我们还需要安装一个包</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge -av app-admin/sudo
</code></pre></td></tr></table></div></div><p>配置sudo</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>sed -i <span class=s1>&#39;s/\# \%wheel ALL=(ALL) ALL/\%wheel ALL=(ALL) ALL/g&#39;</span> /etc/sudoers
</code></pre></td></tr></table></div></div><p>这样在<code>wheel</code>组的用户在使用sudo的时候输入密码的时候就可以使用root的权限运行了。</p><h3 id=安装网络组件-1>安装网络组件</h3><p>可以选择使用dhcp或者是NetworkManager服务去管理服务</p><blockquote><p>dhcp</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>emerge -av dhcpcd 
</code></pre></td></tr></table></div></div><p>开机启动</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>rc-update add dhcpcd default
</code></pre></td></tr></table></div></div><blockquote><p>networkmanager</p></blockquote><p>安装：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>emerge -av networkmanager
</code></pre></td></tr></table></div></div><p>开机启动：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>rc-update add NetworkManager default
</code></pre></td></tr></table></div></div><h3 id=安装系统推荐组件>安装系统推荐组件</h3><blockquote><p>安装记录日志的程序</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge -av app-admin/sysklogd
</code></pre></td></tr></table></div></div><p>加入到开机启动</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>rc-update add sysklogd default
</code></pre></td></tr></table></div></div><blockquote><p>定时任务</p></blockquote><p>cron可以做定时任务，比如说每天，每周，每个月执行什么操作非常方便，建议安装。</p><p>安装定时任务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask sys-process/cronie
</code></pre></td></tr></table></div></div><p>加入到开机启动</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>rc-update add cronie default
</code></pre></td></tr></table></div></div><blockquote><p>文件索引</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask sys-apps/mlocate
</code></pre></td></tr></table></div></div><blockquote><p>远程访问（可选）</p></blockquote><p>开机启动openssh-server</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>rc-update add sshd default
</code></pre></td></tr></table></div></div><h2 id=备份和清理工作>备份和清理工作</h2><h3 id=清理>清理</h3><p>删除之前下载的stage3文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>rm -rf /stage3-amd64-*
</code></pre></td></tr></table></div></div><h3 id=配置文件备份>配置文件备份</h3><p>可以暂时在<code>/root</code>下创建一个备份的文件夹用于备份</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>mdkir -pv /root/dotfiles
</code></pre></td></tr></table></div></div><p>复制我们所修改的文件到这个文件夹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>cp -v /etc/conf.d/hostname /root/dotfiles
cp -v /etc/dracut.conf /root/dotfiles
cp -v /etc/locale.gen /root/dotfiles
cp -v /usr/src/linux/.config /root/kernel-config
cp -v /tmp/workdir/genkernel.conf /root/dotfiles
</code></pre></td></tr></table></div></div><h2 id=重启>重启</h2><p>现在可以准备重启了，我们先要退出chroot环境</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>exit</span>
</code></pre></td></tr></table></div></div><p>然后卸载文件系统</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>umount -R /mnt/gentoo
</code></pre></td></tr></table></div></div><p>最后重启</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>reboot
</code></pre></td></tr></table></div></div><p>在重启过grub的时候会提示让输入LUKS卷的密码输入之后就应该可以正常引导系统了！
但是现在只是基础的系统，距离我们想要用的桌面还还差一点。</p><h2 id=故障排除>故障排除</h2><p>有的时候会遇到一些错误，这里记录一下可能遇到的错误以及如何处理。</p><h2 id=安装和配置桌面>安装和配置桌面</h2><p>这里安装的桌面为KDE桌面，为了方便安装我们首先要切换一下系统的配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>eselect  profile  <span class=nb>set</span> <span class=s2>&#34;default/linux/amd64/17.1/desktop/plasma&#34;</span>
</code></pre></td></tr></table></div></div><p>更新系统</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask --verbose --deep --with-bdeps<span class=o>=</span>y --newuse --update @world
</code></pre></td></tr></table></div></div><p>在更新完成之后我们来安装桌面和必要的包</p><h3 id=安装kde桌面及应用>安装KDE桌面及应用</h3><blockquote><p>KDE
这里安装的是整个KDE+完整的应用：</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>emerge --ask kde-plasma/plasma-meta kde-apps/kde-apps-meta
</code></pre></td></tr></table></div></div><h3 id=配置kde启动>配置KDE启动</h3><p>这次启动我不打算用DM去管理改用<code>startx</code>的方式。</p><p>创建并编辑<code>~/.xinitrc</code>文件:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w ~/.xinitrc
</code></pre></td></tr></table></div></div><p>内容如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>dbus-launch --sh-syntax --exit-with-session<span class=k>)</span><span class=s2>&#34;</span>
<span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/.xprofile&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> . ~/.xprofile
<span class=nb>exec</span> dbus-launch --exit-with-session startplasma-x11
</code></pre></td></tr></table></div></div><p>接下来我们还要创建一个<code>~/.xprofile</code>文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh>nano -w ~/.xprofile
</code></pre></td></tr></table></div></div><p>内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#!/bin/sh
</span><span class=cp></span><span class=c1># Fcitx</span>
<span class=nb>export</span> <span class=nv>GTK_IM_MODULE</span><span class=o>=</span>fcitx
<span class=nb>export</span> <span class=nv>QT_IM_MODULE</span><span class=o>=</span>fcitx
<span class=nb>export</span> <span class=nv>XMODIFIERS</span><span class=o>=</span>@im<span class=o>=</span>fcitx
<span class=nb>export</span> GTK_IM_MODULE <span class=nv>DEFAULT</span><span class=o>=</span>xim
<span class=nb>export</span> QT_IM_MODULE  <span class=nv>DEFAULT</span><span class=o>=</span>xim
</code></pre></td></tr></table></div></div><p>保存退出。
现在输入<code>startx</code>之后就可以启动桌面了。</p><p>现在我们已经算是安装完成了ww。</p><h2 id=最后的话>最后的话</h2><p>这次历时4天的安装体验让我学到了很多，像是Linux的启动流程，Initramfs，内核配置，桌面配置等等。
感受了Gentoo Linux的魅力，虽然这篇文章到这里就结束了，但是这也是我使用Gentoo Linux的开始。
感谢学姐送的Mac，同时也感谢Telegram Gentoo-zh群组热心大神的支持！
是时候回到工作了！</p><h2 id=参考文档>参考文档</h2><ul><li><a href=https://wiki.gentoo.org/wiki/Kernel/Overview>Kernel Overview</a></li><li><a href=http://www.jinbuguo.com/kernel/longterm-linux-kernel-options.html>金步国内核配置文档</a></li><li><a href=https://wiki.gentoo.org/wiki/Special:MyLanguage/Handbook:AMD64/Installation>Gentoo AMD64 Handbook</a></li><li><a href=https://blog.yangmame.org/Gentoo%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B.html>YangMame Gentoo安装教程</a></li><li><a href=https://wiki.gentoo.org/wiki/User:Sakaki/Sakaki%27s_EFI_Install_Guide>Sakaki&rsquo;s EFI Install Guide</a></li><li><a href=https://www.kernel.org/doc/html/latest/>The Linux Kernel Documentation</a></li><li><a href=https://wiki.gentoo.org/wiki/Genkernel>Genkernel</a></li><li><a href=https://wiki.archlinux.org/index.php/HiDPI>Archlinux Wiki HiDIP</a></li><li><a href=https://wiki.gentoo.org/wiki/Dracut>Gentoo Dracut</a></li><li><a href=https://wiki.gentoo.org/wiki/KDE>Gentoo KDE</a></li><li><a href=https://en.wikipedia.org/wiki/Comparison_of_operating_systems>Comparison of operating systems</a></li><li><a href=https://en.wikipedia.org/wiki/Comparison_of_Linux_distributions>Comparison of Linux distributions</a></li><li><a href=https://wiki.archlinux.org/index.php/Arch_Linux>Archlinux wiki</a></li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>Yafa Xena</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2021-01-18</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/linux/>Linux</a>
<a href=/tags/gentoo/>Gentoo</a></div><nav class=post-nav><a class=prev href=/post/setup-my-lab/><i class="iconfont icon-left"></i><span class="prev-text nav-default">设置我的实验环境</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/my-first-posts/><span class="next-text nav-default">My First Posts</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:yafa-xena@protonmail.com class="iconfont icon-email" title=email></a><a href=https://twitter.com/XenaYafa class="iconfont icon-twitter" title=twitter></a><a href=https://github.com/yafa-xena/ class="iconfont icon-github" title=github></a><a href=https://www.yafa.moe/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2021<span class=heart><i class="iconfont icon-heart"></i></span><span>Yafa Xena</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.c12618f9a600c40bd024996677e951e64d3487006775aeb22e200c990006c5c7.js></script><script type=text/javascript>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],tags:'ams',}};</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-194993895-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>